{%- # AJAX Cart Drawer - Modern E-Commerce UX -%}
<div class="cart-drawer" id="cart-drawer" aria-hidden="true" role="dialog" aria-label="Shopping Cart">
  <div class="cart-drawer__overlay" data-cart-drawer-close></div>
  
  <div class="cart-drawer__container">
    {%- # Header -%}
    <div class="cart-drawer__header">
      <h2 class="cart-drawer__title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <span>{{ 'cart.general.title' | t | default: 'Your Cart' }}</span>
        <span class="cart-drawer__count" data-cart-count>{{ cart.item_count }}</span>
      </h2>
      <button type="button" class="cart-drawer__close" data-cart-drawer-close aria-label="Close cart">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    {%- # Cart Items -%}
    <div class="cart-drawer__items" data-cart-items>
      {% if cart.item_count > 0 %}
        {% for item in cart.items %}
          <div class="cart-drawer__item" data-cart-item="{{ item.key }}">
            <div class="cart-drawer__item-image">
              {% if item.image %}
                {{ item.image | image_url: width: 120 | image_tag:
                  alt: item.title,
                  loading: 'lazy',
                  width: 120,
                  height: 120
                }}
              {% endif %}
            </div>
            
            <div class="cart-drawer__item-details">
              <h3 class="cart-drawer__item-title">
                <a href="{{ item.url }}">{{ item.product.title }}</a>
              </h3>
              {% if item.variant.title != 'Default Title' %}
                <p class="cart-drawer__item-variant">{{ item.variant.title }}</p>
              {% endif %}
              
              <div class="cart-drawer__item-price">
                <span class="cart-drawer__item-quantity">{{ item.quantity }} Ã—</span>
                <span>{{ item.final_price | money }}</span>
              </div>
            </div>
            
            <div class="cart-drawer__item-actions">
              <div class="cart-drawer__quantity">
                <button type="button" class="cart-drawer__quantity-btn" data-cart-decrease="{{ item.key }}" aria-label="Decrease quantity">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
                <input 
                  type="number" 
                  class="cart-drawer__quantity-input" 
                  value="{{ item.quantity }}"
                  min="0"
                  data-cart-quantity="{{ item.key }}"
                  aria-label="Quantity for {{ item.title }}"
                >
                <button type="button" class="cart-drawer__quantity-btn" data-cart-increase="{{ item.key }}" aria-label="Increase quantity">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
              
              <button type="button" class="cart-drawer__remove" data-cart-remove="{{ item.key }}" aria-label="Remove {{ item.title }}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="cart-drawer__empty" data-cart-empty>
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <p>{{ 'cart.general.empty' | t | default: 'Your cart is empty' }}</p>
          <a href="{{ routes.all_products_collection_url }}" class="btn btn-primary">
            {{ 'cart.general.continue_shopping' | t | default: 'Continue Shopping' }}
          </a>
        </div>
      {% endif %}
    </div>

    {%- # Footer with totals -%}
    <div class="cart-drawer__footer">
      <div class="cart-drawer__subtotal">
        <span>{{ 'cart.general.subtotal' | t | default: 'Subtotal' }}</span>
        <span class="cart-drawer__subtotal-price" data-cart-subtotal>{{ cart.total_price | money }}</span>
      </div>
      
      <p class="cart-drawer__note">{{ 'cart.general.taxes_and_shipping' | t | default: 'Taxes and shipping calculated at checkout' }}</p>
      
      <div class="cart-drawer__actions">
        <a href="{{ routes.cart_url }}" class="btn btn-secondary btn-full">
          {{ 'cart.general.view_cart' | t | default: 'View Cart' }}
        </a>
        <a href="/checkout" class="btn btn-primary btn-full">
          {{ 'cart.general.checkout' | t | default: 'Checkout' }}
        </a>
      </div>
    </div>
  </div>
</div>

{% stylesheet %}
/* ==========================================================================
   CART DRAWER - Modern AJAX Cart UX
   ========================================================================== */

.cart-drawer {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 9999;
  display: none;
  pointer-events: none;
}

.cart-drawer[aria-hidden="false"] {
  display: block;
  pointer-events: all;
}

.cart-drawer__overlay {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background: rgba(0, 0, 0, 0.5);
  opacity: 0;
  transition: opacity 0.3s ease;
  cursor: pointer;
}

.cart-drawer[aria-hidden="false"] .cart-drawer__overlay {
  opacity: 1;
}

.cart-drawer__container {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  max-width: 420px;
  background: var(--color-surface, #ffffff);
  box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.cart-drawer[aria-hidden="false"] .cart-drawer__container {
  transform: translateX(0);
}

/* Header */
.cart-drawer__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.5rem;
  border-bottom: 1px solid var(--color-border, #E8E8E1);
  flex-shrink: 0;
}

.cart-drawer__title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.25rem;
  font-weight: 700;
  margin: 0;
  color: var(--color-text-primary, #1a1a1a);
}

.cart-drawer__title svg {
  color: var(--color-primary, #FBB03B);
}

.cart-drawer__count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 24px;
  padding: 0 6px;
  background: var(--color-primary, #FBB03B);
  color: #000;
  font-size: 0.75rem;
  font-weight: 700;
  border-radius: 12px;
}

.cart-drawer__close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  padding: 0;
  background: transparent;
  border: none;
  color: var(--color-text-secondary, #666);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.cart-drawer__close:hover {
  background: var(--color-background, #f5f5f5);
  color: var(--color-text-primary, #1a1a1a);
}

/* Items */
.cart-drawer__items {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  -webkit-overflow-scrolling: touch;
}

.cart-drawer__item {
  display: grid;
  grid-template-columns: 80px 1fr auto;
  gap: 1rem;
  padding: 1rem 0;
  border-bottom: 1px solid var(--color-border, #E8E8E1);
}

.cart-drawer__item-image {
  width: 80px;
  height: 80px;
  background: var(--color-background, #f5f5f5);
  border-radius: 8px;
  overflow: hidden;
}

.cart-drawer__item-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.cart-drawer__item-details {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.cart-drawer__item-title {
  font-size: 0.9375rem;
  font-weight: 600;
  margin: 0;
  line-height: 1.3;
}

.cart-drawer__item-title a {
  color: var(--color-text-primary, #1a1a1a);
  text-decoration: none;
}

.cart-drawer__item-title a:hover {
  color: var(--color-primary, #FBB03B);
}

.cart-drawer__item-variant {
  font-size: 0.8125rem;
  color: var(--color-text-secondary, #666);
  margin: 0;
}

.cart-drawer__item-price {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--color-primary, #FBB03B);
  margin-top: auto;
}

.cart-drawer__item-quantity {
  color: var(--color-text-secondary, #666);
  font-weight: 400;
}

/* Actions */
.cart-drawer__item-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.5rem;
}

.cart-drawer__quantity {
  display: flex;
  align-items: center;
  gap: 4px;
  background: var(--color-background, #f5f5f5);
  border-radius: 6px;
  padding: 2px;
}

.cart-drawer__quantity-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  padding: 0;
  background: transparent;
  border: none;
  color: var(--color-text-primary, #1a1a1a);
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.cart-drawer__quantity-btn:hover {
  background: rgba(0, 0, 0, 0.05);
}

.cart-drawer__quantity-input {
  width: 36px;
  height: 28px;
  padding: 0;
  text-align: center;
  border: none;
  background: transparent;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-primary, #1a1a1a);
}

.cart-drawer__quantity-input::-webkit-outer-spin-button,
.cart-drawer__quantity-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.cart-drawer__remove {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  background: transparent;
  border: none;
  color: var(--color-text-secondary, #666);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.cart-drawer__remove:hover {
  background: var(--color-error-light, #fee);
  color: var(--color-error, #dc2626);
}

/* Empty State */
.cart-drawer__empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 3rem 1.5rem;
  min-height: 300px;
}

.cart-drawer__empty svg {
  color: var(--color-border, #E8E8E1);
  margin-bottom: 1.5rem;
}

.cart-drawer__empty p {
  font-size: 1rem;
  color: var(--color-text-secondary, #666);
  margin-bottom: 1.5rem;
}

/* Footer */
.cart-drawer__footer {
  padding: 1.5rem;
  border-top: 1px solid var(--color-border, #E8E8E1);
  background: var(--color-surface, #ffffff);
  flex-shrink: 0;
}

.cart-drawer__subtotal {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  font-size: 1.125rem;
  font-weight: 700;
}

.cart-drawer__subtotal-price {
  color: var(--color-primary, #FBB03B);
}

.cart-drawer__note {
  font-size: 0.8125rem;
  color: var(--color-text-secondary, #666);
  margin: 0 0 1.5rem;
  text-align: center;
}

.cart-drawer__actions {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.btn-full {
  width: 100%;
}

/* Responsive */
@media (max-width: 480px) {
  .cart-drawer__container {
    max-width: 100%;
  }
  
  .cart-drawer__header {
    padding: 1rem;
  }
  
  .cart-drawer__items {
    padding: 0.75rem;
  }
  
  .cart-drawer__footer {
    padding: 1rem;
  }
}

/* Loading State */
.cart-drawer__item--loading {
  opacity: 0.5;
  pointer-events: none;
}
{% endstylesheet %}

{% javascript %}
// AJAX Cart Drawer JavaScript
class CartDrawer {
  constructor() {
    this.drawer = document.getElementById('cart-drawer');
    if (!this.drawer) return;
    
    this.overlay = this.drawer.querySelector('.cart-drawer__overlay');
    this.closeBtn = this.drawer.querySelector('[data-cart-drawer-close]');
    
    this.init();
  }
  
  init() {
    // Open drawer when cart icon clicked
    document.addEventListener('click', (e) => {
      const cartTrigger = e.target.closest('[data-cart-drawer-open], .icon-button--cart');
      if (cartTrigger) {
        e.preventDefault();
        this.open();
      }
    });
    
    // Close drawer
    this.overlay?.addEventListener('click', () => this.close());
    this.closeBtn?.addEventListener('click', () => this.close());
    
    // Quantity controls
    this.drawer.addEventListener('click', (e) => {
      const decreaseBtn = e.target.closest('[data-cart-decrease]');
      const increaseBtn = e.target.closest('[data-cart-increase]');
      const removeBtn = e.target.closest('[data-cart-remove]');
      
      if (decreaseBtn) this.updateQuantity(decreaseBtn.dataset.cartDecrease, -1);
      if (increaseBtn) this.updateQuantity(increaseBtn.dataset.cartIncrease, 1);
      if (removeBtn) this.removeItem(removeBtn.dataset.cartRemove);
    });
    
    // ESC key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.drawer.getAttribute('aria-hidden') === 'false') {
        this.close();
      }
    });
  }
  
  open() {
    this.drawer.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }
  
  close() {
    this.drawer.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }
  
  async updateQuantity(key, change) {
    const input = this.drawer.querySelector(`[data-cart-quantity="${key}"]`);
    if (!input) return;
    
    const newQty = parseInt(input.value) + change;
    if (newQty < 0) return;
    
    await this.updateCart(key, newQty);
  }
  
  async removeItem(key) {
    await this.updateCart(key, 0);
  }
  
  async updateCart(key, quantity) {
    try {
      const response = await fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: key, quantity })
      });
      
      if (!response.ok) throw new Error('Cart update failed');
      
      const cart = await response.json();
      this.refreshDrawer();
      this.updateCartCount(cart.item_count);
    } catch (error) {
      console.error('Cart update error:', error);
    }
  }
  
  async refreshDrawer() {
    // Reload drawer content from /cart endpoint
    try {
      const response = await fetch(window.location.href);
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newDrawer = doc.getElementById('cart-drawer');
      
      if (newDrawer) {
        this.drawer.innerHTML = newDrawer.innerHTML;
      }
    } catch (error) {
      console.error('Drawer refresh error:', error);
      window.location.reload(); // Fallback
    }
  }
  
  updateCartCount(count) {
    document.querySelectorAll('[data-cart-count]').forEach(el => {
      el.textContent = count;
      if (count === 0) {
        el.style.display = 'none';
      } else {
        el.style.display = '';
      }
    });
  }
}

// Initialize cart drawer
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => new CartDrawer());
} else {
  new CartDrawer();
}
{% endjavascript %}
