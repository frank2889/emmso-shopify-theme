{%- assign faqs = nil -%}

{%- if product and product.metafields.custom.faq and product.metafields.custom.faq.value.size >= 2 -%}
  {%- assign faqs = product.metafields.custom.faq.value -%}
{%- elsif collection and collection.metafields.custom.faq and collection.metafields.custom.faq.value.size >= 2 -%}
  {%- assign faqs = collection.metafields.custom.faq.value -%}
{%- elsif blog and blog.metafields.custom.faq and blog.metafields.custom.faq.value.size >= 2 -%}
  {%- assign faqs = blog.metafields.custom.faq.value -%}
{%- elsif article and article.metafields.custom.faq and article.metafields.custom.faq.value.size >= 2 -%}
  {%- assign faqs = article.metafields.custom.faq.value -%}
{%- endif -%}

{%- if faqs -%}
  {%- assign pair_count = faqs.size | divided_by: 2 -%}
  {%- assign last_index = pair_count | minus: 1 -%}
  {%- assign valid_index = 0 -%}

  {%- for i in (0..last_index) -%}
    {%- assign q_index = i | times: 2 -%}
    {%- assign a_index = q_index | plus: 1 -%}
    {%- assign q = faqs[q_index] | strip -%}
    {%- assign a = faqs[a_index] | strip -%}
    {%- if q != blank and a != blank -%}
      {%- assign valid_index = forloop.index -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if valid_index > 0 -%}
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {%- for i in (0..last_index) -%}
      {%- assign q_index = i | times: 2 -%}
      {%- assign a_index = q_index | plus: 1 -%}
      {%- assign q = faqs[q_index] | strip -%}
      {%- assign a = faqs[a_index] | strip -%}
      {%- if q != blank and a != blank -%}
        {
          "@type": "Question",
          "name": {{ q | json }},
          "acceptedAnswer": {
            "@type": "Answer",
            "text": {{ a | json }}
          }
        }{%- unless forloop.index == valid_index -%},{%- endunless -%}
      {%- endif -%}
    {%- endfor -%}
  ]
}
    </script>
  {%- endif -%}
{%- endif -%}
