class SearchEngine{constructor(){this.input=document.querySelector("[data-predictive-search-input]"),this.results=document.querySelector("[data-predictive-search-results]"),this.resultsContainer=document.querySelector("[data-search-results-container]"),this.loading=document.querySelector("[data-search-loading]"),this.footer=document.querySelector("[data-search-footer]"),this.clearBtn=document.querySelector("[data-search-clear]"),this.voiceBtn=document.querySelector("[data-voice-search-button]"),this.viewAllLink=document.querySelector("[data-search-view-all]"),this.cache=new Map,this.recentSearches=this.loadRecentSearches(),this.debounceTimer=null,this.abortController=null,this.intelligence=window.SearchIntelligence?new window.SearchIntelligence:null,this.init()}init(){this.input&&(this.input.addEventListener("input",this.handleInput.bind(this)),this.input.addEventListener("focus",this.handleFocus.bind(this)),this.input.addEventListener("keydown",this.handleKeydown.bind(this)),this.clearBtn&&this.clearBtn.addEventListener("click",this.clearSearch.bind(this)),this.voiceBtn&&"webkitSpeechRecognition"in window?this.voiceBtn.addEventListener("click",this.handleVoiceSearch.bind(this)):this.voiceBtn&&(this.voiceBtn.style.display="none"),document.querySelectorAll("[data-suggestion]").forEach(e=>{e.addEventListener("click",()=>{this.input.value=e.dataset.suggestion,this.performSearch(e.dataset.suggestion)})}),document.addEventListener("click",e=>{e.target.closest(".search-form")||this.hideResults()}),this.resultsContainer&&this.resultsContainer.addEventListener("click",e=>{const t=e.target.closest(".search-result-item__add-to-cart");t&&(e.preventDefault(),e.stopPropagation(),this.handleAddToCart(t))}),this.showRecentSearches())}handleInput(e){const t=e.target.value.trim();if(this.clearBtn&&(this.clearBtn.hidden=0===t.length),clearTimeout(this.debounceTimer),t.length<2)return this.hideResults(),void this.showRecentSearches();this.debounceTimer=setTimeout(()=>{this.performSearch(t)},150)}handleFocus(){0===this.input.value.trim().length&&this.showRecentSearches()}handleKeydown(e){"Escape"===e.key&&(this.hideResults(),this.input.blur())}async performSearch(e){const t=this.intelligence?this.intelligence.analyzeQuery(e):null;if(t&&(console.log("Search Analysis:",t),"search"!==t.intent&&console.log(`Detected intent: ${t.intent}`),t.room&&console.log(`Room context: ${t.room}`),t.characteristics.length>0&&console.log(`Characteristics: ${t.characteristics.join(", ")}`),t.synonyms.length>1&&console.log(`Expanded to ${t.synonyms.length} synonym variations (multilingual)`)),this.cache.has(e))this.displayResults(this.cache.get(e),e,t);else{this.abortController&&this.abortController.abort(),this.abortController=new AbortController,this.showLoading();try{const s=performance.now(),n=this.intelligence?this.intelligence.getQueryVariations(e):[e];console.log(`Searching with ${n.length} variations:`,n);const r=n.slice(0,3).map(e=>fetch(`/search/suggest.json?q=${encodeURIComponent(e)}&resources[type]=product&resources[limit]=12&resources[options][unavailable_products]=last&resources[options][fields]=title,vendor,product_type,tag,variants.title`,{signal:this.abortController.signal}).then(e=>e.ok?e.json():null)),i=await Promise.all(r),a=new Map;i.forEach(e=>{e?.resources?.results?.products&&e.resources.results.products.forEach(e=>{const t=e.id||e.handle;a.has(t)||a.set(t,e)})});const o=Array.from(a.values()),c=performance.now();console.log(`Multilingual search completed in ${(c-s).toFixed(2)}ms - Found ${o.length} unique products`);const l={resources:{results:{products:o}}};if(this.intelligence&&l.resources?.results?.products&&(l.resources.results.products=this.intelligence.rankResults(l.resources.results.products,e,t)),this.cache.set(e,l),this.cache.size>50){const e=this.cache.keys().next().value;this.cache.delete(e)}this.displayResults(l,e,t),this.saveRecentSearch(e)}catch(e){if("AbortError"===e.name)return;console.error("Search error:",e),this.showError()}finally{this.hideLoading()}}}displayResults(e,t,s=null){const n=e.resources.results.products||[];if(0===n.length)return void this.showNoResults(t,s);let r="";if(s&&this.intelligence){const e=this.intelligence.generateSmartSuggestions(t,s);e.length>0&&(r+='<div class="search-insights">',e.slice(0,2).forEach(e=>{r+=`\n            <a href="${e.action}" class="search-insight-chip">\n              <span class="search-insight-icon">ðŸ’¡</span>\n              ${this.escapeHtml(e.text)}\n            </a>\n          `}),r+="</div>"),(s.room||s.characteristics.length>0||s.brands.length>0)&&(r+='<div class="search-context">',r+='<p class="search-context__label">Searching for:</p>',r+='<div class="search-context__tags">',s.room&&(r+=`<span class="context-tag">${s.room} flooring</span>`),s.brands.length>0&&s.brands.forEach(e=>{r+=`<span class="context-tag">${this.escapeHtml(e)}</span>`}),s.characteristics.length>0&&s.characteristics.forEach(e=>{r+=`<span class="context-tag">${e.replace(/-/g," ")}</span>`}),r+="</div></div>")}r+='<div class="search-results__products">',n.slice(0,6).forEach(e=>{const s=e.image||e.featured_image,n=this.formatPrice(e.price),i=e.compare_at_price?this.formatPrice(e.compare_at_price):null,a=e.available,o=e.relevanceScore||0;r+=`\n        <div class="search-result-item" data-product-id="${e.id}" ${o>0?`data-score="${o}"`:""}>\n          <a href="${e.url}" class="search-result-item__link">\n            <div class="search-result-item__image">\n              ${s?`\n                <img \n                  src="${s}" \n                  alt="${this.escapeHtml(e.title)}"\n                  loading="lazy"\n                  width="80"\n                  height="80"\n                >\n              `:'\n                <div class="search-result-item__placeholder"></div>\n              '}\n              ${o>=100?'<span class="search-result-item__match-badge">Best Match</span>':""}\n            </div>\n            <div class="search-result-item__details">\n              <h3 class="search-result-item__title">${this.highlightQuery(e.title,t)}</h3>\n              ${e.vendor?`<p class="search-result-item__vendor">${this.escapeHtml(e.vendor)}</p>`:""}\n              <div class="search-result-item__price">\n                ${i?`<span class="search-result-item__compare-price">${i}</span>`:""}\n                <span class="search-result-item__final-price ${i?"on-sale":""}">${n}</span>\n              </div>\n              ${a?"":'<span class="search-result-item__badge badge-out-of-stock">Out of Stock</span>'}\n            </div>\n          </a>\n          ${a?`\n            <button \n              type="button" \n              class="search-result-item__add-to-cart" \n              data-product-id="${e.id}"\n              data-variant-id="${e.variants?e.variants[0]?.id:e.id}"\n              aria-label="Add ${this.escapeHtml(e.title)} to cart"\n            >\n              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="9" cy="21" r="1"></circle>\n                <circle cx="20" cy="21" r="1"></circle>\n                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>\n              </svg>\n              <span>Add to Cart</span>\n            </button>\n          `:""}\n        </div>\n      `}),r+="</div>",this.resultsContainer.innerHTML=r,this.showResults(),this.viewAllLink&&(this.viewAllLink.href=`/search?q=${encodeURIComponent(t)}`,this.viewAllLink.textContent=`View all ${n.length} results`,this.footer.hidden=!1)}showNoResults(e,t=null){const s=this.generateSuggestions(e);let n=[];t&&this.intelligence&&(n=this.intelligence.generateSmartSuggestions(e,t)),this.resultsContainer.innerHTML=`\n      <div class="search-no-results">\n        <h3>No results found for "${this.escapeHtml(e)}"</h3>\n        \n        ${s.length>0?`\n          <p>Did you mean:</p>\n          <ul class="search-suggestions-list">\n            ${s.map(e=>`\n              <li>\n                <button type="button" class="search-suggestion-link" data-suggestion="${e}">\n                  ${this.escapeHtml(e)}\n                </button>\n              </li>\n            `).join("")}\n          </ul>\n        `:""}\n        \n        ${n.length>0?`\n          <div class="search-alternatives">\n            <p>Try these instead:</p>\n            ${n.map(e=>`\n              <a href="${e.action}" class="search-alternative-link">\n                ${this.escapeHtml(e.text)}\n              </a>\n            `).join("")}\n          </div>\n        `:'\n          <p>Try different keywords or <a href="/collections/all">browse all products</a></p>\n        '}\n        \n        ${t&&t.isQuestion?'\n          <div class="search-help-tip">\n            <p>ðŸ’¡ Looking for help? Visit our <a href="/pages/learning-center">Learning Center</a> for guides and tutorials</p>\n          </div>\n        ':""}\n      </div>\n    `,this.resultsContainer.querySelectorAll("[data-suggestion]").forEach(e=>{e.addEventListener("click",()=>{this.input.value=e.dataset.suggestion,this.performSearch(e.dataset.suggestion)})}),this.showResults()}showLoading(){this.loading&&(this.loading.hidden=!1)}hideLoading(){this.loading&&(this.loading.hidden=!0)}showResults(){this.results&&(this.results.hidden=!1)}hideResults(){this.results&&(this.results.hidden=!0),this.footer&&(this.footer.hidden=!0)}showError(){this.resultsContainer.innerHTML='\n      <div class="search-error">\n        <p>Something went wrong. Please try again.</p>\n      </div>\n    ',this.showResults()}clearSearch(){this.input.value="",this.input.focus(),this.hideResults(),this.showRecentSearches(),this.clearBtn&&(this.clearBtn.hidden=!0)}handleVoiceSearch(){const e=new webkitSpeechRecognition;e.lang=document.documentElement.lang||"en-US",e.continuous=!1,e.interimResults=!1,e.onresult=e=>{const t=e.results[0][0].transcript;this.input.value=t,this.performSearch(t)},e.onerror=e=>{console.error("Voice search error:",e.error)},e.start()}loadRecentSearches(){try{const e=localStorage.getItem("emmso_recent_searches");return e?JSON.parse(e):[]}catch(e){return[]}}saveRecentSearch(e){if(e&&!(e.length<2)){this.recentSearches=this.recentSearches.filter(t=>t!==e),this.recentSearches.unshift(e),this.recentSearches=this.recentSearches.slice(0,5);try{localStorage.setItem("emmso_recent_searches",JSON.stringify(this.recentSearches))}catch(e){console.warn("Could not save recent searches")}}}showRecentSearches(){const e=document.querySelector("[data-recent-searches]"),t=document.querySelector("[data-recent-list]");e&&t&&0!==this.recentSearches.length&&(t.innerHTML=this.recentSearches.map(e=>`\n      <li>\n        <button type="button" class="search-suggestion-chip" data-suggestion="${e}">\n          ${this.escapeHtml(e)}\n        </button>\n      </li>\n    `).join(""),t.querySelectorAll("[data-suggestion]").forEach(e=>{e.addEventListener("click",()=>{this.input.value=e.dataset.suggestion,this.performSearch(e.dataset.suggestion)})}),e.hidden=!1)}formatPrice(e){const t=e/100;return new Intl.NumberFormat(document.documentElement.lang||"en-US",{style:"currency",currency:window.Shopify?.currency?.active||"EUR"}).format(t)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}highlightQuery(e,t){const s=new RegExp(`(${t})`,"gi");return this.escapeHtml(e).replace(s,"<mark>$1</mark>")}generateSuggestions(e){return["laminate","vinyl","wood","floor","flooring","care","adhesive","sealer","cleaner","maintenance","parquet","tile","stone","oak","walnut","herringbone","planks","protection","finish","oil"].map(t=>({term:t,distance:this.levenshteinDistance(e.toLowerCase(),t.toLowerCase())})).filter(e=>e.distance<=3).sort((e,t)=>e.distance-t.distance).slice(0,3).map(e=>e.term)}levenshteinDistance(e,t){const s=[];for(let e=0;e<=t.length;e++)s[e]=[e];for(let t=0;t<=e.length;t++)s[0][t]=t;for(let n=1;n<=t.length;n++)for(let r=1;r<=e.length;r++)t.charAt(n-1)===e.charAt(r-1)?s[n][r]=s[n-1][r-1]:s[n][r]=Math.min(s[n-1][r-1]+1,s[n][r-1]+1,s[n-1][r]+1);return s[t.length][e.length]}async handleAddToCart(e){const t=e.dataset.variantId;e.dataset.productId;if(!t)return void console.error("No variant ID found for Add to Cart");e.disabled=!0,e.classList.add("adding");const s=e.querySelector("span").textContent;e.querySelector("span").textContent="Adding...";try{const n=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,quantity:1})});if(!n.ok)throw new Error("Failed to add to cart");await n.json();e.classList.remove("adding"),e.classList.add("added"),e.querySelector("span").textContent="Added!",this.updateCartCount(),setTimeout(()=>{e.classList.remove("added"),e.querySelector("span").textContent=s,e.disabled=!1},2e3)}catch(t){console.error("Add to cart error:",t),e.classList.remove("adding"),e.querySelector("span").textContent="Error",setTimeout(()=>{e.querySelector("span").textContent=s,e.disabled=!1},2e3)}}updateCartCount(){fetch("/cart.js").then(e=>e.json()).then(e=>{const t=document.querySelector(".cart-count");t&&(t.textContent=e.item_count,t.hidden=0===e.item_count)}).catch(e=>console.error("Cart count update failed:",e))}}if("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new SearchEngine}):new SearchEngine,window.PerformanceObserver){new PerformanceObserver(e=>{for(const t of e.getEntries())t.name.includes("search/suggest")&&console.log(`Search API: ${t.duration.toFixed(2)}ms`)}).observe({entryTypes:["resource"]})}