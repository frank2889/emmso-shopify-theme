class Cart{constructor(){this.cartWrapper = document.querySelector('[data-cart-wrapper]');this.cartForm = document.querySelector('[data-cart-form]');this.cartItems = document.querySelector('[data-cart-items]');this.shippingBar = document.querySelector('[data-shipping-bar]');this.checkoutButton = document.querySelector('[data-checkout-button]');if(!this.cartWrapper)return;this.init();}init(){this.bindEvents();this.updateShippingProgress();this.bindUpsellButtons();}bindEvents(){const increaseButtons = this.cartWrapper.querySelectorAll('[data-qty-increase]');increaseButtons.forEach(button =>{button.addEventListener('click',(e)=> this.handleQuantityChange(e,'increase'));});const decreaseButtons = this.cartWrapper.querySelectorAll('[data-qty-decrease]');decreaseButtons.forEach(button =>{button.addEventListener('click',(e)=> this.handleQuantityChange(e,'decrease'));});const qtyInputs = this.cartWrapper.querySelectorAll('[data-qty-input]');qtyInputs.forEach(input =>{input.addEventListener('change',this.debounce((e)=>{this.handleQuantityInput(e);},500));});const removeButtons = this.cartWrapper.querySelectorAll('[data-remove-item]');removeButtons.forEach(button =>{button.addEventListener('click',(e)=> this.handleRemoveItem(e));});if(this.cartForm){this.cartForm.addEventListener('submit',(e)=>{if(!e.submitter || e.submitter.name !== 'checkout'){e.preventDefault();}});}}async handleQuantityChange(e,action){const button = e.currentTarget;const index = button.dataset.index;const input = this.cartWrapper.querySelector(`[data-qty-input][data-index="${index}"]`);if(!input)return;const currentQty = parseInt(input.value);const newQty = action === 'increase' ? currentQty + 1:Math.max(0,currentQty - 1);input.value = newQty;await this.updateCart(index,newQty);}async handleQuantityInput(e){const input = e.currentTarget;const index = input.dataset.index;const newQty = parseInt(input.value)|| 0;await this.updateCart(index,newQty);}async handleRemoveItem(e){e.preventDefault();const button = e.currentTarget;const index = button.dataset.index;if(confirm(window.theme?.translations?.cart?.confirmRemove || 'Remove this item?')){await this.updateCart(index,0);}}async updateCart(lineIndex,quantity){try{this.setLoadingState(true,lineIndex);const response = await fetch('/cart/change.js',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({line:lineIndex,quantity:quantity})});if(!response.ok){throw new Error('Failed to update cart');}const cart = await response.json();if(quantity === 0){this.removeItemFromDOM(lineIndex);}this.updateCartTotals(cart);this.updateShippingProgress(cart);if(cart.item_count === 0){window.location.reload();}}catch(error){console.error('Cart update error:',error);this.showError('Failed to update cart. Please try again.');setTimeout(()=> window.location.reload(),2000);}finally{this.setLoadingState(false,lineIndex);}}removeItemFromDOM(lineIndex){const item = this.cartWrapper.querySelector(`[data-cart-item][data-line-index="${lineIndex}"]`);if(item){item.style.opacity = '0';item.style.transform = 'translateX(-20px)';setTimeout(()=> item.remove(),300);}}updateCartTotals(cart){const subtotalElement = document.querySelector('[data-cart-subtotal]');if(subtotalElement){subtotalElement.textContent = this.formatMoney(cart.total_price);}const cartCountElements = document.querySelectorAll('[data-cart-count]');cartCountElements.forEach(el =>{el.textContent = cart.item_count;});}updateShippingProgress(cart = null){if(!this.shippingBar)return;const threshold = parseInt(this.shippingBar.dataset.threshold || 5000);const currentTotal = cart ? cart.total_price:this.getCurrentCartTotal();const remaining = Math.max(0,threshold - currentTotal);const progress = Math.min(100,(currentTotal / threshold)* 100);const progressFill = this.shippingBar.querySelector('.cart__shipping-fill');if(progressFill){progressFill.style.width = `${progress}%`;}const message = this.shippingBar.querySelector('.cart__shipping-message');if(message){if(remaining > 0){message.textContent = `Add ${this.formatMoney(remaining)}more for free shipping`;message.classList.remove('cart__shipping-message--success');}else{message.textContent = 'ğŸ‰ You qualify for free shipping!';message.classList.add('cart__shipping-message--success');}}}getCurrentCartTotal(){const subtotalElement = document.querySelector('[data-cart-subtotal]');if(!subtotalElement)return 0;const text = subtotalElement.textContent;const number = parseFloat(text.replace(/[^0-9,.]/g,'').replace(',','.'));return Math.round(number * 100);}setLoadingState(isLoading,lineIndex = null){if(lineIndex){const item = this.cartWrapper.querySelector(`[data-cart-item][data-line-index="${lineIndex}"]`);if(item){item.classList.toggle('cart-item--loading',isLoading);}}if(this.checkoutButton){this.checkoutButton.classList.toggle('cart__checkout-button--loading',isLoading);this.checkoutButton.disabled = isLoading;}}showError(message){alert(message);}formatMoney(cents){const amount =(cents / 100).toFixed(2);return `â‚¬${amount}`;}debounce(func,wait){let timeout;return function executedFunction(...args){const later =()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout = setTimeout(later,wait);};}bindUpsellButtons(){const upsellButtons = document.querySelectorAll('.cart__upsell-add-to-cart');upsellButtons.forEach(button =>{button.addEventListener('click',(e)=> this.handleUpsellAddToCart(e));});const popularButtons = document.querySelectorAll('.cart__popular-add-to-cart');popularButtons.forEach(button =>{button.addEventListener('click',(e)=> this.handleUpsellAddToCart(e));});}async handleUpsellAddToCart(event){const button = event.currentTarget;const variantId = button.dataset.variantId;const productId = button.dataset.productId;if(!variantId){console.error('No variant ID found');return;}button.classList.add('is-adding');button.disabled = true;const originalText = button.querySelector('span').textContent;button.querySelector('span').textContent = 'Adding...';try{const response = await fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({items:[{id:variantId,quantity:1}]})});if(!response.ok){throw new Error('Failed to add to cart');}const result = await response.json();button.classList.remove('is-adding');button.classList.add('is-added');button.querySelector('span').textContent = 'Added!';this.updateCartCount();setTimeout(()=>{window.location.reload();},800);}catch(error){console.error('Error adding to cart:',error);button.classList.remove('is-adding');button.querySelector('span').textContent = 'Error!';setTimeout(()=>{button.querySelector('span').textContent = originalText;button.disabled = false;},2000);}}async updateCartCount(){try{const response = await fetch('/cart.js');const cart = await response.json();const cartCountElements = document.querySelectorAll('.cart-count');cartCountElements.forEach(el =>{el.textContent = cart.item_count;if(cart.item_count > 0){el.style.display = 'flex';}});const cartLinks = document.querySelectorAll('[aria-label*="Cart"]');cartLinks.forEach(link =>{link.setAttribute('aria-label',`Cart(${cart.item_count})`);});}catch(error){console.error('Error updating cart count:',error);}}}if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',()=> new Cart());}else{new Cart();}window.Cart = Cart;