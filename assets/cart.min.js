class Cart{constructor(){this.cartWrapper=document.querySelector("[data-cart-wrapper]"),this.cartForm=document.querySelector("[data-cart-form]"),this.cartItems=document.querySelector("[data-cart-items]"),this.shippingBar=document.querySelector("[data-shipping-bar]"),this.checkoutButton=document.querySelector("[data-checkout-button]"),this.cartWrapper&&this.init()}init(){this.bindEvents(),this.updateShippingProgress(),this.bindUpsellButtons()}bindEvents(){this.cartWrapper.querySelectorAll("[data-qty-increase]").forEach(t=>{t.addEventListener("click",t=>this.handleQuantityChange(t,"increase"))});this.cartWrapper.querySelectorAll("[data-qty-decrease]").forEach(t=>{t.addEventListener("click",t=>this.handleQuantityChange(t,"decrease"))});this.cartWrapper.querySelectorAll("[data-qty-input]").forEach(t=>{t.addEventListener("change",this.debounce(t=>{this.handleQuantityInput(t)},500))});this.cartWrapper.querySelectorAll("[data-remove-item]").forEach(t=>{t.addEventListener("click",t=>this.handleRemoveItem(t))}),this.cartForm&&this.cartForm.addEventListener("submit",t=>{t.submitter&&"checkout"===t.submitter.name||t.preventDefault()})}async handleQuantityChange(t,e){const a=t.currentTarget.dataset.index,r=this.cartWrapper.querySelector(`[data-qty-input][data-index="${a}"]`);if(!r)return;const n=parseInt(r.value),o="increase"===e?n+1:Math.max(0,n-1);r.value=o,await this.updateCart(a,o)}async handleQuantityInput(t){const e=t.currentTarget,a=e.dataset.index,r=parseInt(e.value)||0;await this.updateCart(a,r)}async handleRemoveItem(t){t.preventDefault();const e=t.currentTarget.dataset.index;confirm(window.theme?.translations?.cart?.confirmRemove||"Remove this item?")&&await this.updateCart(e,0)}async updateCart(t,e){try{this.setLoadingState(!0,t);const a=await fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({line:t,quantity:e})});if(!a.ok)throw new Error("Failed to update cart");const r=await a.json();0===e&&this.removeItemFromDOM(t),this.updateCartTotals(r),this.updateShippingProgress(r),0===r.item_count&&window.location.reload()}catch(t){console.error("Cart update error:",t),this.showError("Failed to update cart. Please try again."),setTimeout(()=>window.location.reload(),2e3)}finally{this.setLoadingState(!1,t)}}removeItemFromDOM(t){const e=this.cartWrapper.querySelector(`[data-cart-item][data-line-index="${t}"]`);e&&(e.style.opacity="0",e.style.transform="translateX(-20px)",setTimeout(()=>e.remove(),300))}updateCartTotals(t){const e=document.querySelector("[data-cart-subtotal]");e&&(e.textContent=this.formatMoney(t.total_price));document.querySelectorAll("[data-cart-count]").forEach(e=>{e.textContent=t.item_count})}updateShippingProgress(t=null){if(!this.shippingBar)return;const e=parseInt(this.shippingBar.dataset.threshold||5e3),a=t?t.total_price:this.getCurrentCartTotal(),r=Math.max(0,e-a),n=Math.min(100,a/e*100),o=this.shippingBar.querySelector(".cart__shipping-fill");o&&(o.style.width=`${n}%`);const i=this.shippingBar.querySelector(".cart__shipping-message");i&&(r>0?(i.textContent=`Add ${this.formatMoney(r)} more for free shipping`,i.classList.remove("cart__shipping-message--success")):(i.textContent="ğŸ‰ You qualify for free shipping!",i.classList.add("cart__shipping-message--success")))}getCurrentCartTotal(){const t=document.querySelector("[data-cart-subtotal]");if(!t)return 0;const e=t.textContent,a=parseFloat(e.replace(/[^0-9,.]/g,"").replace(",","."));return Math.round(100*a)}setLoadingState(t,e=null){if(e){const a=this.cartWrapper.querySelector(`[data-cart-item][data-line-index="${e}"]`);a&&a.classList.toggle("cart-item--loading",t)}this.checkoutButton&&(this.checkoutButton.classList.toggle("cart__checkout-button--loading",t),this.checkoutButton.disabled=t)}showError(t){alert(t)}formatMoney(t){return`â‚¬${(t/100).toFixed(2)}`}debounce(t,e){let a;return function(...r){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),t(...r)},e)}}bindUpsellButtons(){document.querySelectorAll(".cart__upsell-add-to-cart").forEach(t=>{t.addEventListener("click",t=>this.handleUpsellAddToCart(t))});document.querySelectorAll(".cart__popular-add-to-cart").forEach(t=>{t.addEventListener("click",t=>this.handleUpsellAddToCart(t))})}async handleUpsellAddToCart(t){const e=t.currentTarget,a=e.dataset.variantId;e.dataset.productId;if(!a)return void console.error("No variant ID found");e.classList.add("is-adding"),e.disabled=!0;const r=e.querySelector("span").textContent;e.querySelector("span").textContent="Adding...";try{const t=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[{id:a,quantity:1}]})});if(!t.ok)throw new Error("Failed to add to cart");await t.json();e.classList.remove("is-adding"),e.classList.add("is-added"),e.querySelector("span").textContent="Added!",this.updateCartCount(),setTimeout(()=>{window.location.reload()},800)}catch(t){console.error("Error adding to cart:",t),e.classList.remove("is-adding"),e.querySelector("span").textContent="Error!",setTimeout(()=>{e.querySelector("span").textContent=r,e.disabled=!1},2e3)}}async updateCartCount(){try{const t=await fetch("/cart.js"),e=await t.json();document.querySelectorAll(".cart-count").forEach(t=>{t.textContent=e.item_count,e.item_count>0&&(t.style.display="flex")});document.querySelectorAll('[aria-label*="Cart"]').forEach(t=>{t.setAttribute("aria-label",`Cart (${e.item_count})`)})}catch(t){console.error("Error updating cart count:",t)}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>new Cart):new Cart,window.Cart=Cart;