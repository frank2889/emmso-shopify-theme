class UnifiedFilters{constructor(config ={}){this.context = this.detectContext();this.queryNormalizer = new QueryNormalizer();this.config ={mode:config.mode || 'full',enableSmartRedirect:config.enableSmartRedirect !== false,enableAutoCollectionCreation:config.enableAutoCollectionCreation || false,productsPerPage:config.productsPerPage || 24,enableInfiniteScroll:config.enableInfiniteScroll || false,enableComparison:config.enableComparison || false,minProductsForCollection:config.minProductsForCollection || 10,minQualityScore:config.minQualityScore || 0.5,...config};this.filters ={category:[],brand:[],room:[],characteristics:[],priceMin:null,priceMax:null};this.products = [];this.filteredProducts = [];this.currentPage = 1;this.sortBy = 'relevance';this.viewMode = 'grid';this.init();}detectContext(){const path = window.location.pathname;if(path.includes('/collections/')){return 'collection';}else if(path.includes('/products/')){return 'product';}else if(path.includes('/search')){return 'search';}return 'unknown';}init(){this.cacheElements();this.attachEventListeners();this.loadFromURL();switch(this.context){case 'collection':this.initCollection();break;case 'product':this.initProduct();break;case 'search':this.initSearch();break;}}async initCollection(){const collectionHandle = this.getCollectionHandle();try{const response = await fetch(`/collections/${collectionHandle}/products.json?limit=250`);const data = await response.json();this.products = data.products;this.buildDynamicFilters();this.applyFilters();if(this.shouldRedirectToCollection()){this.performSmartRedirect();}}catch(error){console.error('Collection load error:',error);this.showEmpty();}}async initProduct(){const productHandle = this.getProductHandle();try{const response = await fetch(`/products/${productHandle}.js`);const product = await response.json();await this.fetchRelatedProducts(product);this.buildDynamicFilters();this.applyFilters();}catch(error){console.error('Product load error:',error);}}async initSearch(){const query = new URLSearchParams(window.location.search).get('q')|| '';if(this.resultQuery){this.resultQuery.textContent = query ? `for "${query}"`:'';}try{if(this.config.enableSmartRedirect && await this.shouldRedirectToCollection(query)){return;}const response = await fetch(`/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=250`);const data = await response.json();this.products = data.resources.results.products || [];this.buildDynamicFilters();this.applyFilters();}catch(error){console.error('Search error:',error);this.showEmpty();}}async fetchRelatedProducts(product){const queries = [ `vendor:${product.vendor}`,product.tags?.slice(0,3).join(' OR ')|| '',`product_type:${product.product_type}` ];const allProducts = new Set();for(const query of queries){if(!query)continue;try{const response = await fetch(`/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=50`);const data = await response.json();data.resources.results.products?.forEach(p =>{if(p.id !== product.id){allProducts.add(p);}});}catch(error){console.error(`Related products query error:${query}`,error);}}this.products = Array.from(allProducts).slice(0,50);}async shouldRedirectToCollection(query){if(!query || this.context !== 'search' || !this.config.enableSmartRedirect){return false;}const locale = document.documentElement.lang || 'en';const normalized = this.queryNormalizer.normalize(query,locale);console.info('Query normalization:',{original:normalized.original,normalized:normalized.normalized,handle:normalized.handle,qualityScore:normalized.qualityScore,shouldCreateCollection:normalized.shouldCreateCollection,reason:normalized.reason});if(normalized.isSpam){console.warn('Spam query detected,staying on search:',query);return false;}try{const response = await fetch('/collections.json');if(!response.ok){console.info('Collections not available,continuing with search-first approach');if(this.config.enableAutoCollectionCreation && normalized.shouldCreateCollection){this.requestCollectionCreation(normalized,this.products);}return false;}const data = await response.json();const collections = data.collections || [];if(collections.length === 0){console.info('No collections exist yet,using search-first approach');return false;}const match = this.queryNormalizer.findMatchingCollection(query,collections,locale);if(match){console.info('Found matching collection:',{query:query,collection:match.collection.handle,matchType:match.matchType,confidence:match.confidence});const params = new URLSearchParams(window.location.search);params.delete('q');const filterParams = params.toString();const redirectUrl = `/collections/${match.collection.handle}${filterParams ? '?' + filterParams:''}`;window.location.href = redirectUrl;return true;}console.info('No matching collection found for:',normalized.handle);if(this.config.enableAutoCollectionCreation && normalized.shouldCreateCollection && this.products.length >= this.config.minProductsForCollection){console.info('Query qualifies for collection creation:',{handle:normalized.handle,products:this.products.length,qualityScore:normalized.qualityScore});this.requestCollectionCreation(normalized,this.products);}}catch(error){console.info('Collections check failed,using search-first approach:',error.message);}return false;}async requestCollectionCreation(normalizedQuery,products){if(!this.config.collectionWebhookUrl){console.warn('Auto-collection creation enabled but no webhook URL configured');return;}try{await fetch(this.config.collectionWebhookUrl,{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({query:normalizedQuery.original,handle:normalizedQuery.handle,title:this.generateCollectionTitle(normalizedQuery.normalized),productCount:products.length,productIds:products.slice(0,250).map(p => p.id),automatedRules:this.generateAutomatedRules(normalizedQuery.normalized),qualityScore:normalizedQuery.qualityScore,locale:document.documentElement.lang || 'en'})});console.info('Collection creation requested:',normalizedQuery.handle);}catch(error){console.error('Failed to request collection creation:',error);}}generateCollectionTitle(normalizedQuery){return normalizedQuery .split(' ').map(word => word.charAt(0).toUpperCase()+ word.slice(1)).join(' ');}generateAutomatedRules(normalizedQuery){const words = normalizedQuery.split(' ');const rules = words.map(word =>({column:'tag',relation:'equals',condition:word}));return{rules:rules,disjunctive:false,sortOrder:'best-selling'};}buildDynamicFilters(){const categories = new Set();const brands = new Set();const rooms = new Set();const characteristics = new Set();let minPrice = Infinity;let maxPrice = -Infinity;this.products.forEach(product =>{if(product.product_type){categories.add(product.product_type);}if(product.vendor){brands.add(product.vendor);}const price = product.price ? product.price / 100:0;minPrice = Math.min(minPrice,price);maxPrice = Math.max(maxPrice,price);product.tags?.forEach(tag =>{if(tag.includes('room:')|| tag.includes('ruimte:')|| tag.includes('raum:')|| tag.includes('pièce:')|| tag.includes('habitación:')|| tag.includes('stanza:')){rooms.add(tag.split(':')[1]);}if(tag.includes('feature:')|| tag.includes('eigenschap:')|| tag.includes('caratteristica:')){characteristics.add(tag.split(':')[1]);}});});this.renderFilterOptions('category',Array.from(categories));this.renderFilterOptions('brand',Array.from(brands));this.renderFilterOptions('room',Array.from(rooms));this.renderFilterOptions('characteristics',Array.from(characteristics));this.setPriceRange(minPrice,maxPrice);}renderFilterOptions(filterType,options){const container = document.querySelector(`[data-filter-content="${filterType}"]`);if(!container || options.length === 0){const group = document.querySelector(`[data-filter-group="${filterType}"]`);if(group)group.style.display = 'none';return;}const group = document.querySelector(`[data-filter-group="${filterType}"]`);if(group)group.style.display = '';options.sort();const html = options.map(option =>{const id = `filter-${filterType}-${option.replace(/\s+/g,'-').toLowerCase()}`;const count = this.products.filter(p => this.productMatchesFilter(p,filterType,option)).length;const isChecked = this.filters[filterType].includes(option);return ` <label class="filter-option"> <input type="checkbox" class="filter-option__checkbox" id="${id}" data-filter-type="${filterType}" data-filter-value="${option}" ${isChecked ? 'checked':''}> <span class="filter-option__label">${option}</span> <span class="filter-option__count">(${count})</span> </label> `;}).join('');container.innerHTML = html;container.querySelectorAll('input[type="checkbox"]').forEach(checkbox =>{checkbox.addEventListener('change',(e)=>{this.handleFilterChange(e.target.dataset.filterType,e.target.dataset.filterValue,e.target.checked);});});}productMatchesFilter(product,filterType,value){switch(filterType){case 'category':return product.product_type === value;case 'brand':return product.vendor === value;case 'room':return product.tags?.some(tag =>(tag.includes('room:')|| tag.includes('ruimte:')|| tag.includes('raum:'))&& tag.split(':')[1] === value);case 'characteristics':return product.tags?.some(tag =>(tag.includes('feature:')|| tag.includes('eigenschap:'))&& tag.split(':')[1] === value);default:return false;}}setPriceRange(min,max){const priceMin = document.querySelector('[data-price-min]');const priceMax = document.querySelector('[data-price-max]');if(priceMin){priceMin.placeholder = `€${Math.floor(min)}`;priceMin.min = Math.floor(min);}if(priceMax){priceMax.placeholder = `€${Math.ceil(max)}`;priceMax.max = Math.ceil(max);}}handleFilterChange(filterType,value,checked){if(checked){if(!this.filters[filterType].includes(value)){this.filters[filterType].push(value);}}else{this.filters[filterType] = this.filters[filterType].filter(v => v !== value);}this.applyFilters();}applyFilters(){this.filteredProducts = this.products.filter(product =>{if(this.filters.category.length > 0){if(!this.filters.category.includes(product.product_type)){return false;}}if(this.filters.brand.length > 0){if(!this.filters.brand.includes(product.vendor)){return false;}}if(this.filters.room.length > 0){const hasRoom = product.tags?.some(tag =>(tag.includes('room:')|| tag.includes('ruimte:'))&& this.filters.room.includes(tag.split(':')[1]));if(!hasRoom)return false;}if(this.filters.characteristics.length > 0){const hasAllCharacteristics = this.filters.characteristics.every(char => product.tags?.some(tag =>(tag.includes('feature:')|| tag.includes('eigenschap:'))&& tag.split(':')[1] === char));if(!hasAllCharacteristics)return false;}const price = product.price / 100;if(this.filters.priceMin !== null && price < this.filters.priceMin){return false;}if(this.filters.priceMax !== null && price > this.filters.priceMax){return false;}return true;});this.sortProducts();this.updateActiveFilters();this.updateResultCount();this.renderProducts();this.updateURL();}sortProducts(){switch(this.sortBy){case 'price-asc':this.filteredProducts.sort((a,b)=> a.price - b.price);break;case 'price-desc':this.filteredProducts.sort((a,b)=> b.price - a.price);break;case 'newest':this.filteredProducts.sort((a,b)=> new Date(b.created_at)- new Date(a.created_at));break;case 'best-selling':break;case 'relevance':default:break;}}renderProducts(){if(!this.productGrid)return;if(this.filteredProducts.length === 0){this.showEmpty();return;}this.hideLoading();this.hideEmpty();const start =(this.currentPage - 1)* this.config.productsPerPage;const end = start + this.config.productsPerPage;const productsToShow = this.filteredProducts.slice(start,end);const html = productsToShow.map(product => this.renderProductCard(product)).join('');if(this.currentPage === 1){this.productGrid.innerHTML = html;}else{this.productGrid.insertAdjacentHTML('beforeend',html);}this.updateLoadMore(end < this.filteredProducts.length);}renderProductCard(product){const price = product.price / 100;const inStock = product.available !== false;const variantId = product.variants && product.variants[0] ? product.variants[0].id:product.id;const cardClass = this.context === 'product' ? 'related-product-card':'product-card';const imageSize = this.context === 'product' ? 200:(this.viewMode === 'list' ? 200:400);return ` <article class="${cardClass}${cardClass}--${this.viewMode}" data-product-id="${product.id}"> ${this.context !== 'product' ? ` <div class="product-card__compare"> <label class="compare-label"> <input type="checkbox" class="compare-checkbox" data-compare-product="${product.id}" aria-label="Compare ${product.title}" > </label> </div> `:''}<a href="${product.url}" class="${cardClass}__link"> <div class="${cardClass}__image-wrapper"> <img src="${product.featured_image || '/assets/placeholder.svg'}" alt="${product.title}" loading="lazy" width="${imageSize}" height="${imageSize}" class="${cardClass}__image" > </div> <div class="${cardClass}__content"> <p class="${cardClass}__vendor">${product.vendor}</p> <h3 class="${cardClass}__title">${product.title}</h3> <div class="${cardClass}__price-wrapper"> <span class="${cardClass}__price"> <span class="${cardClass}__price-value">€${price.toFixed(2)}</span> </span> </div> <span class="${cardClass}__availability ${inStock ? 'in-stock':'out-of-stock'}"> ${inStock ? 'In Stock':'Out of Stock'}</span> </div> </a> ${inStock ? ` <button type="button" class="product-card__add-to-cart" data-product-id="${product.id}" data-variant-id="${variantId}" aria-label="Add ${product.title}to cart" > <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <circle cx="9" cy="21" r="1"></circle> <circle cx="20" cy="21" r="1"></circle> <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path> </svg> <span>Add to Cart</span> </button> `:''}</article> `;}updateActiveFilters(){if(!this.filterChipsContainer)return;const activeFilters = [];this.filters.category.forEach(value =>{activeFilters.push({type:'category',value});});this.filters.brand.forEach(value =>{activeFilters.push({type:'brand',value});});this.filters.room.forEach(value =>{activeFilters.push({type:'room',value});});this.filters.characteristics.forEach(value =>{activeFilters.push({type:'characteristics',value});});if(this.filters.priceMin !== null || this.filters.priceMax !== null){const min = this.filters.priceMin !== null ? `€${this.filters.priceMin}`:'';const max = this.filters.priceMax !== null ? `€${this.filters.priceMax}`:'';const label = min && max ? `${min}- ${max}`:(min || `up to ${max}`);activeFilters.push({type:'price',value:label,isPriceFilter:true});}if(activeFilters.length === 0){this.activeFiltersContainer?.classList.add('hidden');this.filterChipsContainer.innerHTML = '';return;}this.activeFiltersContainer?.classList.remove('hidden');const html = activeFilters.map(filter => ` <button class="filter-chip" data-remove-filter="${filter.type}" ${filter.isPriceFilter ? '':`data-filter-value="${filter.value}"`}> ${filter.value}<svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"> <path d="M11 1L1 11M1 1L11 11" stroke="currentColor" stroke-width="2"/> </svg> </button> `).join('');this.filterChipsContainer.innerHTML = html;this.filterChipsContainer.querySelectorAll('[data-remove-filter]').forEach(chip =>{chip.addEventListener('click',()=>{if(chip.dataset.removeFilter === 'price'){this.filters.priceMin = null;this.filters.priceMax = null;const priceMin = document.querySelector('[data-price-min]');const priceMax = document.querySelector('[data-price-max]');if(priceMin)priceMin.value = '';if(priceMax)priceMax.value = '';}else{this.handleFilterChange(chip.dataset.removeFilter,chip.dataset.filterValue,false);const checkbox = document.querySelector(`input[data-filter-type="${chip.dataset.removeFilter}"][data-filter-value="${chip.dataset.filterValue}"]`);if(checkbox)checkbox.checked = false;}this.applyFilters();});});}updateResultCount(){if(!this.resultCount)return;this.resultCount.textContent = this.filteredProducts.length;}updateURL(){const params = new URLSearchParams();if(this.context === 'search'){const query = new URLSearchParams(window.location.search).get('q');if(query)params.set('q',query);}if(this.filters.category.length > 0){params.set('category',this.filters.category.join(','));}if(this.filters.brand.length > 0){params.set('brand',this.filters.brand.join(','));}if(this.filters.room.length > 0){params.set('room',this.filters.room.join(','));}if(this.filters.characteristics.length > 0){params.set('characteristics',this.filters.characteristics.join(','));}if(this.filters.priceMin !== null){params.set('priceMin',this.filters.priceMin);}if(this.filters.priceMax !== null){params.set('priceMax',this.filters.priceMax);}if(this.sortBy !== 'relevance'){params.set('sort',this.sortBy);}const newUrl = `${window.location.pathname}${params.toString()? '?' + params.toString():''}`;window.history.pushState({},'',newUrl);}loadFromURL(){const params = new URLSearchParams(window.location.search);if(params.has('category')){this.filters.category = params.get('category').split(',');}if(params.has('brand')){this.filters.brand = params.get('brand').split(',');}if(params.has('room')){this.filters.room = params.get('room').split(',');}if(params.has('characteristics')){this.filters.characteristics = params.get('characteristics').split(',');}if(params.has('priceMin')){this.filters.priceMin = parseFloat(params.get('priceMin'));}if(params.has('priceMax')){this.filters.priceMax = parseFloat(params.get('priceMax'));}if(params.has('sort')){this.sortBy = params.get('sort');}}clearAllFilters(){this.filters ={category:[],brand:[],room:[],characteristics:[],priceMin:null,priceMax:null};document.querySelectorAll('.filter-option__checkbox').forEach(checkbox =>{checkbox.checked = false;});const priceMin = document.querySelector('[data-price-min]');const priceMax = document.querySelector('[data-price-max]');if(priceMin)priceMin.value = '';if(priceMax)priceMax.value = '';this.applyFilters();}toggleView(mode){this.viewMode = mode;this.viewToggles?.forEach(btn =>{if(btn.dataset.view === mode){btn.classList.add('active');btn.setAttribute('aria-pressed','true');}else{btn.classList.remove('active');btn.setAttribute('aria-pressed','false');}});if(this.productGrid){this.productGrid.className = `product-grid product-grid--${mode}`;}this.currentPage = 1;this.renderProducts();}loadMore(){this.currentPage++;this.renderProducts();}handleScroll(){if(!this.config.enableInfiniteScroll)return;if(!this.loadMoreContainer)return;const rect = this.loadMoreContainer.getBoundingClientRect();const isVisible = rect.top < window.innerHeight && rect.bottom >= 0;if(isVisible && this.currentPage * this.config.productsPerPage < this.filteredProducts.length){this.loadMore();}}updateLoadMore(hasMore){if(!this.loadMoreContainer)return;if(hasMore){this.loadMoreContainer.classList.remove('hidden');}else{this.loadMoreContainer.classList.add('hidden');}}showLoading(){if(this.loadingState)this.loadingState.classList.remove('hidden');if(this.productGrid)this.productGrid.classList.add('hidden');if(this.emptyState)this.emptyState.classList.add('hidden');}hideLoading(){if(this.loadingState)this.loadingState.classList.add('hidden');if(this.productGrid)this.productGrid.classList.remove('hidden');}showEmpty(){if(this.emptyState)this.emptyState.classList.remove('hidden');if(this.productGrid)this.productGrid.classList.add('hidden');if(this.loadingState)this.loadingState.classList.add('hidden');}hideEmpty(){if(this.emptyState)this.emptyState.classList.add('hidden');}getCollectionHandle(){const match = window.location.pathname.match(/\/collections\/([^\/]+)/);return match ? match[1]:null;}getProductHandle(){const match = window.location.pathname.match(/\/products\/([^\/]+)/);return match ? match[1]:null;}cacheElements(){this.filterGroups = document.querySelectorAll('[data-filter-group]');this.activeFiltersContainer = document.querySelector('[data-active-filters]');this.filterChipsContainer = document.querySelector('[data-filter-chips]');this.clearAllBtn = document.querySelector('[data-clear-all]');this.productGrid = document.querySelector('[data-product-grid]');this.loadingState = document.querySelector('[data-loading-state]');this.emptyState = document.querySelector('[data-empty-state]');this.loadMoreBtn = document.querySelector('[data-load-more-btn]');this.loadMoreContainer = document.querySelector('[data-load-more]');this.resultCount = document.querySelector('[data-result-count]');this.resultQuery = document.querySelector('[data-result-query]');this.sortSelect = document.querySelector('[data-sort-select]');this.viewToggles = document.querySelectorAll('[data-view]');}attachEventListeners(){this.filterGroups.forEach(group =>{const toggle = group.querySelector('.filter-group__toggle');toggle?.addEventListener('click',()=> this.toggleFilterGroup(group));});this.clearAllBtn?.addEventListener('click',()=> this.clearAllFilters());const priceMin = document.querySelector('[data-price-min]');const priceMax = document.querySelector('[data-price-max]');priceMin?.addEventListener('change',(e)=>{this.filters.priceMin = e.target.value ? parseFloat(e.target.value):null;this.applyFilters();});priceMax?.addEventListener('change',(e)=>{this.filters.priceMax = e.target.value ? parseFloat(e.target.value):null;this.applyFilters();});this.sortSelect?.addEventListener('change',(e)=>{this.sortBy = e.target.value;this.currentPage = 1;this.applyFilters();});this.viewToggles.forEach(btn =>{btn.addEventListener('click',()=> this.toggleView(btn.dataset.view));});this.loadMoreBtn?.addEventListener('click',()=> this.loadMore());if(this.config.enableInfiniteScroll){window.addEventListener('scroll',()=> this.handleScroll());}this.productGrid?.addEventListener('click',(e)=>{const addToCartBtn = e.target.closest('.product-card__add-to-cart');if(addToCartBtn){e.preventDefault();this.handleAddToCart(addToCartBtn);}});}toggleFilterGroup(group){const toggle = group.querySelector('.filter-group__toggle');const content = group.querySelector('.filter-group__content');const isExpanded = toggle.getAttribute('aria-expanded')=== 'true';toggle.setAttribute('aria-expanded',!isExpanded);content.hidden = isExpanded;}async handleAddToCart(button){const variantId = button.dataset.variantId;const productId = button.dataset.productId;button.disabled = true;button.classList.add('adding');const originalText = button.querySelector('span').textContent;button.querySelector('span').textContent = 'Adding...';try{const response = await fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({id:variantId,quantity:1})});if(!response.ok){throw new Error('Failed to add to cart');}button.classList.remove('adding');button.classList.add('added');button.querySelector('span').textContent = 'Added!';this.updateCartCount();setTimeout(()=>{button.classList.remove('added');button.disabled = false;button.querySelector('span').textContent = originalText;},2000);}catch(error){console.error('Add to cart error:',error);button.classList.remove('adding');button.querySelector('span').textContent = 'Error';setTimeout(()=>{button.disabled = false;button.querySelector('span').textContent = originalText;},2000);}}async updateCartCount(){try{const response = await fetch('/cart.js');const cart = await response.json();const cartCountElement = document.querySelector('.cart-count');if(cartCountElement){cartCountElement.textContent = cart.item_count;cartCountElement.hidden = cart.item_count === 0;}}catch(error){console.error('Cart count update error:',error);}}}document.addEventListener('DOMContentLoaded',()=>{const context = window.location.pathname;if(context.includes('/search')|| context.includes('/collections/')|| context.includes('/products/')){let config ={};if(context.includes('/products/')){config ={mode:'compact',productsPerPage:12,enableComparison:false,enableSmartRedirect:false};}else if(context.includes('/collections/')){config ={mode:'full',productsPerPage:24,enableComparison:true,enableInfiniteScroll:false,enableSmartRedirect:true};}else if(context.includes('/search')){config ={mode:'full',productsPerPage:24,enableComparison:true,enableInfiniteScroll:false,enableSmartRedirect:true};}window.unifiedFilters = new UnifiedFilters(config);}});