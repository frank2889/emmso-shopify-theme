class UnifiedFilters{constructor(t={}){this.context=this.detectContext(),this.queryNormalizer=new QueryNormalizer,this.config={mode:t.mode||"full",enableSmartRedirect:!1!==t.enableSmartRedirect,enableAutoCollectionCreation:t.enableAutoCollectionCreation||!1,productsPerPage:t.productsPerPage||24,enableInfiniteScroll:t.enableInfiniteScroll||!1,enableComparison:t.enableComparison||!1,minProductsForCollection:t.minProductsForCollection||10,minQualityScore:t.minQualityScore||.5,...t},this.filters={category:[],brand:[],room:[],characteristics:[],priceMin:null,priceMax:null},this.products=[],this.filteredProducts=[],this.currentPage=1,this.sortBy="relevance",this.viewMode="grid",this.init()}detectContext(){const t=window.location.pathname;return t.includes("/collections/")?"collection":t.includes("/products/")?"product":t.includes("/search")?"search":"unknown"}init(){switch(this.cacheElements(),this.attachEventListeners(),this.loadFromURL(),this.context){case"collection":this.initCollection();break;case"product":this.initProduct();break;case"search":this.initSearch()}}async initCollection(){const t=this.getCollectionHandle();try{const e=await fetch(`/collections/${t}/products.json?limit=250`),i=await e.json();this.products=i.products,this.buildDynamicFilters(),this.applyFilters(),this.shouldRedirectToCollection()&&this.performSmartRedirect()}catch(t){console.error("Collection load error:",t),this.showEmpty()}}async initProduct(){const t=this.getProductHandle();try{const e=await fetch(`/products/${t}.js`),i=await e.json();await this.fetchRelatedProducts(i),this.buildDynamicFilters(),this.applyFilters()}catch(t){console.error("Product load error:",t)}}async initSearch(){const t=new URLSearchParams(window.location.search).get("q")||"";this.resultQuery&&(this.resultQuery.textContent=t?`for "${t}"`:"");try{if(this.config.enableSmartRedirect&&await this.shouldRedirectToCollection(t))return;const e=await fetch(`/search/suggest.json?q=${encodeURIComponent(t)}&resources[type]=product&resources[limit]=250`),i=await e.json();this.products=i.resources.results.products||[],this.buildDynamicFilters(),this.applyFilters()}catch(t){console.error("Search error:",t),this.showEmpty()}}async fetchRelatedProducts(t){const e=[`vendor:${t.vendor}`,t.tags?.slice(0,3).join(" OR ")||"",`product_type:${t.product_type}`],i=new Set;for(const r of e)if(r)try{const e=await fetch(`/search/suggest.json?q=${encodeURIComponent(r)}&resources[type]=product&resources[limit]=50`),s=await e.json();s.resources.results.products?.forEach(e=>{e.id!==t.id&&i.add(e)})}catch(t){console.error(`Related products query error: ${r}`,t)}this.products=Array.from(i).slice(0,50)}async shouldRedirectToCollection(t){if(!t||"search"!==this.context||!this.config.enableSmartRedirect)return!1;const e=document.documentElement.lang||"en",i=this.queryNormalizer.normalize(t,e);if(console.info("Query normalization:",{original:i.original,normalized:i.normalized,handle:i.handle,qualityScore:i.qualityScore,shouldCreateCollection:i.shouldCreateCollection,reason:i.reason}),i.isSpam)return console.warn("Spam query detected, staying on search:",t),!1;try{const r=await fetch("/collections.json");if(!r.ok)return console.info("Collections not available, continuing with search-first approach"),this.config.enableAutoCollectionCreation&&i.shouldCreateCollection&&this.requestCollectionCreation(i,this.products),!1;const s=(await r.json()).collections||[];if(0===s.length)return console.info("No collections exist yet, using search-first approach"),!1;const o=this.queryNormalizer.findMatchingCollection(t,s,e);if(o){console.info("Found matching collection:",{query:t,collection:o.collection.handle,matchType:o.matchType,confidence:o.confidence});const e=new URLSearchParams(window.location.search);e.delete("q");const i=e.toString(),r=`/collections/${o.collection.handle}${i?"?"+i:""}`;return window.location.href=r,!0}console.info("No matching collection found for:",i.handle),this.config.enableAutoCollectionCreation&&i.shouldCreateCollection&&this.products.length>=this.config.minProductsForCollection&&(console.info("Query qualifies for collection creation:",{handle:i.handle,products:this.products.length,qualityScore:i.qualityScore}),this.requestCollectionCreation(i,this.products))}catch(t){console.info("Collections check failed, using search-first approach:",t.message)}return!1}async requestCollectionCreation(t,e){if(this.config.collectionWebhookUrl)try{await fetch(this.config.collectionWebhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t.original,handle:t.handle,title:this.generateCollectionTitle(t.normalized),productCount:e.length,productIds:e.slice(0,250).map(t=>t.id),automatedRules:this.generateAutomatedRules(t.normalized),qualityScore:t.qualityScore,locale:document.documentElement.lang||"en"})}),console.info("Collection creation requested:",t.handle)}catch(t){console.error("Failed to request collection creation:",t)}else console.warn("Auto-collection creation enabled but no webhook URL configured")}generateCollectionTitle(t){return t.split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}generateAutomatedRules(t){return{rules:t.split(" ").map(t=>({column:"tag",relation:"equals",condition:t})),disjunctive:!1,sortOrder:"best-selling"}}buildDynamicFilters(){const t=new Set,e=new Set,i=new Set,r=new Set;let s=1/0,o=-1/0;this.products.forEach(n=>{n.product_type&&t.add(n.product_type),n.vendor&&e.add(n.vendor);const a=n.price?n.price/100:0;s=Math.min(s,a),o=Math.max(o,a),n.tags?.forEach(t=>{(t.includes("room:")||t.includes("ruimte:")||t.includes("raum:")||t.includes("pièce:")||t.includes("habitación:")||t.includes("stanza:"))&&i.add(t.split(":")[1]),(t.includes("feature:")||t.includes("eigenschap:")||t.includes("caratteristica:"))&&r.add(t.split(":")[1])})}),this.renderFilterOptions("category",Array.from(t)),this.renderFilterOptions("brand",Array.from(e)),this.renderFilterOptions("room",Array.from(i)),this.renderFilterOptions("characteristics",Array.from(r)),this.setPriceRange(s,o)}renderFilterOptions(t,e){const i=document.querySelector(`[data-filter-content="${t}"]`);if(!i||0===e.length){const e=document.querySelector(`[data-filter-group="${t}"]`);return void(e&&(e.style.display="none"))}const r=document.querySelector(`[data-filter-group="${t}"]`);r&&(r.style.display=""),e.sort();const s=e.map(e=>{const i=`filter-${t}-${e.replace(/\s+/g,"-").toLowerCase()}`,r=this.products.filter(i=>this.productMatchesFilter(i,t,e)).length,s=this.filters[t].includes(e);return`\n        <label class="filter-option">\n          <input \n            type="checkbox" \n            class="filter-option__checkbox" \n            id="${i}"\n            data-filter-type="${t}"\n            data-filter-value="${e}"\n            ${s?"checked":""}\n          >\n          <span class="filter-option__label">${e}</span>\n          <span class="filter-option__count">(${r})</span>\n        </label>\n      `}).join("");i.innerHTML=s,i.querySelectorAll('input[type="checkbox"]').forEach(t=>{t.addEventListener("change",t=>{this.handleFilterChange(t.target.dataset.filterType,t.target.dataset.filterValue,t.target.checked)})})}productMatchesFilter(t,e,i){switch(e){case"category":return t.product_type===i;case"brand":return t.vendor===i;case"room":return t.tags?.some(t=>(t.includes("room:")||t.includes("ruimte:")||t.includes("raum:"))&&t.split(":")[1]===i);case"characteristics":return t.tags?.some(t=>(t.includes("feature:")||t.includes("eigenschap:"))&&t.split(":")[1]===i);default:return!1}}setPriceRange(t,e){const i=document.querySelector("[data-price-min]"),r=document.querySelector("[data-price-max]");i&&(i.placeholder=`€${Math.floor(t)}`,i.min=Math.floor(t)),r&&(r.placeholder=`€${Math.ceil(e)}`,r.max=Math.ceil(e))}handleFilterChange(t,e,i){i?this.filters[t].includes(e)||this.filters[t].push(e):this.filters[t]=this.filters[t].filter(t=>t!==e),this.applyFilters()}applyFilters(){this.filteredProducts=this.products.filter(t=>{if(this.filters.category.length>0&&!this.filters.category.includes(t.product_type))return!1;if(this.filters.brand.length>0&&!this.filters.brand.includes(t.vendor))return!1;if(this.filters.room.length>0){const e=t.tags?.some(t=>(t.includes("room:")||t.includes("ruimte:"))&&this.filters.room.includes(t.split(":")[1]));if(!e)return!1}if(this.filters.characteristics.length>0){if(!this.filters.characteristics.every(e=>t.tags?.some(t=>(t.includes("feature:")||t.includes("eigenschap:"))&&t.split(":")[1]===e)))return!1}const e=t.price/100;return!(null!==this.filters.priceMin&&e<this.filters.priceMin)&&!(null!==this.filters.priceMax&&e>this.filters.priceMax)}),this.sortProducts(),this.updateActiveFilters(),this.updateResultCount(),this.renderProducts(),this.updateURL()}sortProducts(){switch(this.sortBy){case"price-asc":this.filteredProducts.sort((t,e)=>t.price-e.price);break;case"price-desc":this.filteredProducts.sort((t,e)=>e.price-t.price);break;case"newest":this.filteredProducts.sort((t,e)=>new Date(e.created_at)-new Date(t.created_at))}}renderProducts(){if(!this.productGrid)return;if(0===this.filteredProducts.length)return void this.showEmpty();this.hideLoading(),this.hideEmpty();const t=(this.currentPage-1)*this.config.productsPerPage,e=t+this.config.productsPerPage,i=this.filteredProducts.slice(t,e).map(t=>this.renderProductCard(t)).join("");1===this.currentPage?this.productGrid.innerHTML=i:this.productGrid.insertAdjacentHTML("beforeend",i),this.updateLoadMore(e<this.filteredProducts.length)}renderProductCard(t){const e=t.price/100,i=!1!==t.available,r=t.variants&&t.variants[0]?t.variants[0].id:t.id,s="product"===this.context?"related-product-card":"product-card",o="product"===this.context||"list"===this.viewMode?200:400;return`\n      <article class="${s} ${s}--${this.viewMode}" data-product-id="${t.id}">\n        ${"product"!==this.context?`\n          <div class="product-card__compare">\n            <label class="compare-label">\n              <input \n                type="checkbox" \n                class="compare-checkbox" \n                data-compare-product="${t.id}"\n                aria-label="Compare ${t.title}"\n              >\n            </label>\n          </div>\n        `:""}\n        \n        <a href="${t.url}" class="${s}__link">\n          <div class="${s}__image-wrapper">\n            <img \n              src="${t.featured_image||"/assets/placeholder.svg"}" \n              alt="${t.title}"\n              loading="lazy"\n              width="${o}"\n              height="${o}"\n              class="${s}__image"\n            >\n          </div>\n          \n          <div class="${s}__content">\n            <p class="${s}__vendor">${t.vendor}</p>\n            <h3 class="${s}__title">${t.title}</h3>\n            \n            <div class="${s}__price-wrapper">\n              <span class="${s}__price">\n                <span class="${s}__price-value">€${e.toFixed(2)}</span>\n              </span>\n            </div>\n            \n            <span class="${s}__availability ${i?"in-stock":"out-of-stock"}">\n              ${i?"In Stock":"Out of Stock"}\n            </span>\n          </div>\n        </a>\n        \n        ${i?`\n          <button \n            type="button" \n            class="product-card__add-to-cart" \n            data-product-id="${t.id}"\n            data-variant-id="${r}"\n            aria-label="Add ${t.title} to cart"\n          >\n            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <circle cx="9" cy="21" r="1"></circle>\n              <circle cx="20" cy="21" r="1"></circle>\n              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>\n            </svg>\n            <span>Add to Cart</span>\n          </button>\n        `:""}\n      </article>\n    `}updateActiveFilters(){if(!this.filterChipsContainer)return;const t=[];if(this.filters.category.forEach(e=>{t.push({type:"category",value:e})}),this.filters.brand.forEach(e=>{t.push({type:"brand",value:e})}),this.filters.room.forEach(e=>{t.push({type:"room",value:e})}),this.filters.characteristics.forEach(e=>{t.push({type:"characteristics",value:e})}),null!==this.filters.priceMin||null!==this.filters.priceMax){const e=null!==this.filters.priceMin?`€${this.filters.priceMin}`:"",i=null!==this.filters.priceMax?`€${this.filters.priceMax}`:"",r=e&&i?`${e} - ${i}`:e||`up to ${i}`;t.push({type:"price",value:r,isPriceFilter:!0})}if(0===t.length)return this.activeFiltersContainer?.classList.add("hidden"),void(this.filterChipsContainer.innerHTML="");this.activeFiltersContainer?.classList.remove("hidden");const e=t.map(t=>`\n      <button \n        class="filter-chip" \n        data-remove-filter="${t.type}"\n        ${t.isPriceFilter?"":`data-filter-value="${t.value}"`}\n      >\n        ${t.value}\n        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">\n          <path d="M11 1L1 11M1 1L11 11" stroke="currentColor" stroke-width="2"/>\n        </svg>\n      </button>\n    `).join("");this.filterChipsContainer.innerHTML=e,this.filterChipsContainer.querySelectorAll("[data-remove-filter]").forEach(t=>{t.addEventListener("click",()=>{if("price"===t.dataset.removeFilter){this.filters.priceMin=null,this.filters.priceMax=null;const t=document.querySelector("[data-price-min]"),e=document.querySelector("[data-price-max]");t&&(t.value=""),e&&(e.value="")}else{this.handleFilterChange(t.dataset.removeFilter,t.dataset.filterValue,!1);const e=document.querySelector(`input[data-filter-type="${t.dataset.removeFilter}"][data-filter-value="${t.dataset.filterValue}"]`);e&&(e.checked=!1)}this.applyFilters()})})}updateResultCount(){this.resultCount&&(this.resultCount.textContent=this.filteredProducts.length)}updateURL(){const t=new URLSearchParams;if("search"===this.context){const e=new URLSearchParams(window.location.search).get("q");e&&t.set("q",e)}this.filters.category.length>0&&t.set("category",this.filters.category.join(",")),this.filters.brand.length>0&&t.set("brand",this.filters.brand.join(",")),this.filters.room.length>0&&t.set("room",this.filters.room.join(",")),this.filters.characteristics.length>0&&t.set("characteristics",this.filters.characteristics.join(",")),null!==this.filters.priceMin&&t.set("priceMin",this.filters.priceMin),null!==this.filters.priceMax&&t.set("priceMax",this.filters.priceMax),"relevance"!==this.sortBy&&t.set("sort",this.sortBy);const e=`${window.location.pathname}${t.toString()?"?"+t.toString():""}`;window.history.pushState({},"",e)}loadFromURL(){const t=new URLSearchParams(window.location.search);t.has("category")&&(this.filters.category=t.get("category").split(",")),t.has("brand")&&(this.filters.brand=t.get("brand").split(",")),t.has("room")&&(this.filters.room=t.get("room").split(",")),t.has("characteristics")&&(this.filters.characteristics=t.get("characteristics").split(",")),t.has("priceMin")&&(this.filters.priceMin=parseFloat(t.get("priceMin"))),t.has("priceMax")&&(this.filters.priceMax=parseFloat(t.get("priceMax"))),t.has("sort")&&(this.sortBy=t.get("sort"))}clearAllFilters(){this.filters={category:[],brand:[],room:[],characteristics:[],priceMin:null,priceMax:null},document.querySelectorAll(".filter-option__checkbox").forEach(t=>{t.checked=!1});const t=document.querySelector("[data-price-min]"),e=document.querySelector("[data-price-max]");t&&(t.value=""),e&&(e.value=""),this.applyFilters()}toggleView(t){this.viewMode=t,this.viewToggles?.forEach(e=>{e.dataset.view===t?(e.classList.add("active"),e.setAttribute("aria-pressed","true")):(e.classList.remove("active"),e.setAttribute("aria-pressed","false"))}),this.productGrid&&(this.productGrid.className=`product-grid product-grid--${t}`),this.currentPage=1,this.renderProducts()}loadMore(){this.currentPage++,this.renderProducts()}handleScroll(){if(!this.config.enableInfiniteScroll)return;if(!this.loadMoreContainer)return;const t=this.loadMoreContainer.getBoundingClientRect();t.top<window.innerHeight&&t.bottom>=0&&this.currentPage*this.config.productsPerPage<this.filteredProducts.length&&this.loadMore()}updateLoadMore(t){this.loadMoreContainer&&(t?this.loadMoreContainer.classList.remove("hidden"):this.loadMoreContainer.classList.add("hidden"))}showLoading(){this.loadingState&&this.loadingState.classList.remove("hidden"),this.productGrid&&this.productGrid.classList.add("hidden"),this.emptyState&&this.emptyState.classList.add("hidden")}hideLoading(){this.loadingState&&this.loadingState.classList.add("hidden"),this.productGrid&&this.productGrid.classList.remove("hidden")}showEmpty(){this.emptyState&&this.emptyState.classList.remove("hidden"),this.productGrid&&this.productGrid.classList.add("hidden"),this.loadingState&&this.loadingState.classList.add("hidden")}hideEmpty(){this.emptyState&&this.emptyState.classList.add("hidden")}getCollectionHandle(){const t=window.location.pathname.match(/\/collections\/([^\/]+)/);return t?t[1]:null}getProductHandle(){const t=window.location.pathname.match(/\/products\/([^\/]+)/);return t?t[1]:null}cacheElements(){this.filterGroups=document.querySelectorAll("[data-filter-group]"),this.activeFiltersContainer=document.querySelector("[data-active-filters]"),this.filterChipsContainer=document.querySelector("[data-filter-chips]"),this.clearAllBtn=document.querySelector("[data-clear-all]"),this.productGrid=document.querySelector("[data-product-grid]"),this.loadingState=document.querySelector("[data-loading-state]"),this.emptyState=document.querySelector("[data-empty-state]"),this.loadMoreBtn=document.querySelector("[data-load-more-btn]"),this.loadMoreContainer=document.querySelector("[data-load-more]"),this.resultCount=document.querySelector("[data-result-count]"),this.resultQuery=document.querySelector("[data-result-query]"),this.sortSelect=document.querySelector("[data-sort-select]"),this.viewToggles=document.querySelectorAll("[data-view]")}attachEventListeners(){this.filterGroups.forEach(t=>{const e=t.querySelector(".filter-group__toggle");e?.addEventListener("click",()=>this.toggleFilterGroup(t))}),this.clearAllBtn?.addEventListener("click",()=>this.clearAllFilters());const t=document.querySelector("[data-price-min]"),e=document.querySelector("[data-price-max]");t?.addEventListener("change",t=>{this.filters.priceMin=t.target.value?parseFloat(t.target.value):null,this.applyFilters()}),e?.addEventListener("change",t=>{this.filters.priceMax=t.target.value?parseFloat(t.target.value):null,this.applyFilters()}),this.sortSelect?.addEventListener("change",t=>{this.sortBy=t.target.value,this.currentPage=1,this.applyFilters()}),this.viewToggles.forEach(t=>{t.addEventListener("click",()=>this.toggleView(t.dataset.view))}),this.loadMoreBtn?.addEventListener("click",()=>this.loadMore()),this.config.enableInfiniteScroll&&window.addEventListener("scroll",()=>this.handleScroll()),this.productGrid?.addEventListener("click",t=>{const e=t.target.closest(".product-card__add-to-cart");e&&(t.preventDefault(),this.handleAddToCart(e))})}toggleFilterGroup(t){const e=t.querySelector(".filter-group__toggle"),i=t.querySelector(".filter-group__content"),r="true"===e.getAttribute("aria-expanded");e.setAttribute("aria-expanded",!r),i.hidden=r}async handleAddToCart(t){const e=t.dataset.variantId;t.dataset.productId;t.disabled=!0,t.classList.add("adding");const i=t.querySelector("span").textContent;t.querySelector("span").textContent="Adding...";try{if(!(await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,quantity:1})})).ok)throw new Error("Failed to add to cart");t.classList.remove("adding"),t.classList.add("added"),t.querySelector("span").textContent="Added!",this.updateCartCount(),setTimeout(()=>{t.classList.remove("added"),t.disabled=!1,t.querySelector("span").textContent=i},2e3)}catch(e){console.error("Add to cart error:",e),t.classList.remove("adding"),t.querySelector("span").textContent="Error",setTimeout(()=>{t.disabled=!1,t.querySelector("span").textContent=i},2e3)}}async updateCartCount(){try{const t=await fetch("/cart.js"),e=await t.json(),i=document.querySelector(".cart-count");i&&(i.textContent=e.item_count,i.hidden=0===e.item_count)}catch(t){console.error("Cart count update error:",t)}}}document.addEventListener("DOMContentLoaded",()=>{const t=window.location.pathname;if(t.includes("/search")||t.includes("/collections/")||t.includes("/products/")){let e={};t.includes("/products/")?e={mode:"compact",productsPerPage:12,enableComparison:!1,enableSmartRedirect:!1}:(t.includes("/collections/")||t.includes("/search"))&&(e={mode:"full",productsPerPage:24,enableComparison:!0,enableInfiniteScroll:!1,enableSmartRedirect:!0}),window.unifiedFilters=new UnifiedFilters(e)}});