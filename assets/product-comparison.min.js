class ProductComparison{constructor(e={}){this.config={maxProducts:e.maxProducts||4,storageKey:e.storageKey||"product-comparison",locale:e.locale||document.documentElement.lang||"en",...e},this.comparedProducts=[],this.loadFromStorage(),this.init()}init(){this.cacheElements(),this.attachEventListeners(),this.updateUI(),this.createComparisonModal()}cacheElements(){this.compareBar=document.querySelector("[data-compare-bar]"),this.compareCount=document.querySelector("[data-compare-count]"),this.compareButton=document.querySelector("[data-compare-button]"),this.clearCompareButton=document.querySelector("[data-clear-compare]"),this.compareCheckboxes=document.querySelectorAll("[data-compare-product]")}attachEventListeners(){this.compareButton?.addEventListener("click",()=>this.showComparison()),this.clearCompareButton?.addEventListener("click",()=>this.clearAll()),document.addEventListener("change",e=>{if(e.target.matches("[data-compare-product]")){const o=e.target.dataset.compareProduct;e.target.checked?this.addProduct(o):this.removeProduct(o)}}),document.addEventListener("keydown",e=>{if("c"===e.key&&!e.ctrlKey&&!e.metaKey&&this.comparedProducts.length>=2){const o=e.target;"INPUT"!==o.tagName&&"TEXTAREA"!==o.tagName&&this.showComparison()}})}async addProduct(e){if(this.comparedProducts.length>=this.config.maxProducts){this.showNotification(this.translate("comparison.max_reached",{max:this.config.maxProducts}),"warning");const o=document.querySelector(`[data-compare-product="${e}"]`);return void(o&&(o.checked=!1))}if(this.comparedProducts.find(o=>o.id===e))return;const o=await this.fetchProductData(e);o?(this.comparedProducts.push(o),this.saveToStorage(),this.updateUI(),this.showNotification(this.translate("comparison.added",{product:o.title}),"success")):this.showNotification(this.translate("comparison.error_loading"),"error")}removeProduct(e){this.comparedProducts=this.comparedProducts.filter(o=>o.id!==e),this.saveToStorage(),this.updateUI();const o=document.querySelector(`[data-compare-product="${e}"]`);o&&(o.checked=!1)}clearAll(){this.comparedProducts=[],this.saveToStorage(),this.updateUI(),document.querySelectorAll("[data-compare-product]:checked").forEach(e=>{e.checked=!1}),this.showNotification(this.translate("comparison.cleared"),"info")}async fetchProductData(e){try{const o=document.querySelector(`[data-product-id="${e}"]`);if(o)return this.extractProductFromCard(o,e);const t=await fetch(`/products/${e}.js`),r=await t.json();return{id:r.id,handle:r.handle,title:r.title,vendor:r.vendor,type:r.product_type,price:r.price/100,compareAtPrice:r.compare_at_price?r.compare_at_price/100:null,available:r.available,url:`/products/${r.handle}`,image:r.featured_image,description:r.description,tags:r.tags||[],variants:r.variants||[],options:r.options||[],metafields:r.metafields||{}}}catch(e){return console.error("Error fetching product:",e),null}}extractProductFromCard(e,o){return{id:o,title:e.querySelector(".product-card__title")?.textContent.trim()||"",vendor:e.querySelector(".product-card__vendor")?.textContent.trim()||"",price:parseFloat(e.querySelector(".product-card__price")?.textContent.replace(/[^0-9.]/g,"")||0),available:!e.querySelector(".product-card__availability")?.classList.contains("out-of-stock"),url:e.querySelector(".product-card__link")?.href||"",image:e.querySelector(".product-card__image")?.src||"",tags:[],variants:[]}}updateUI(){const e=this.comparedProducts.length;this.compareCount&&(this.compareCount.textContent=e),this.compareBar&&(e>0?this.compareBar.classList.remove("hidden"):this.compareBar.classList.add("hidden")),this.compareButton&&(this.compareButton.disabled=e<2),this.comparedProducts.forEach(e=>{const o=document.querySelector(`[data-compare-product="${e.id}"]`);o&&!o.checked&&(o.checked=!0)})}createComparisonModal(){if(document.getElementById("product-comparison-modal"))return;const e=document.createElement("div");e.id="product-comparison-modal",e.className="comparison-modal",e.innerHTML=`\n      <div class="comparison-modal__overlay" data-close-modal></div>\n      <div class="comparison-modal__content">\n        <div class="comparison-modal__header">\n          <h2 class="comparison-modal__title">${this.translate("comparison.title")}</h2>\n          <button class="comparison-modal__close" data-close-modal>\n            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">\n              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n            </svg>\n          </button>\n        </div>\n        <div class="comparison-modal__body" data-comparison-table></div>\n      </div>\n    `,document.body.appendChild(e),e.querySelectorAll("[data-close-modal]").forEach(e=>{e.addEventListener("click",()=>this.hideComparison())}),document.addEventListener("keydown",o=>{"Escape"===o.key&&e.classList.contains("active")&&this.hideComparison()})}showComparison(){if(this.comparedProducts.length<2)return void this.showNotification(this.translate("comparison.min_required"),"warning");const e=document.getElementById("product-comparison-modal");e.querySelector("[data-comparison-table]").innerHTML=this.buildComparisonTable(),e.classList.add("active"),document.body.style.overflow="hidden"}hideComparison(){document.getElementById("product-comparison-modal").classList.remove("active"),document.body.style.overflow=""}buildComparisonTable(){const e=this.comparedProducts,o=this.extractAttributes(e);let t='<div class="comparison-table">';t+='<div class="comparison-row comparison-row--header">',t+='<div class="comparison-cell comparison-cell--label"></div>',e.forEach(e=>{t+=`\n        <div class="comparison-cell comparison-cell--product">\n          <button class="comparison-remove" data-remove-product="${e.id}" title="${this.translate("comparison.remove")}">\n            <svg width="16" height="16" viewBox="0 0 16 16">\n              <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2"/>\n            </svg>\n          </button>\n          <img src="${e.image}" alt="${e.title}" class="comparison-product-image">\n          <h3 class="comparison-product-title">${e.title}</h3>\n          <p class="comparison-product-vendor">${e.vendor}</p>\n          <a href="${e.url}" class="comparison-view-link">${this.translate("comparison.view_product")}</a>\n        </div>\n      `}),t+="</div>",t+=this.buildAttributeRow(this.translate("comparison.price"),e,e=>this.formatPrice(e.price),"price"),t+=this.buildAttributeRow(this.translate("comparison.availability"),e,e=>e.available?`<span class="comparison-badge comparison-badge--success">${this.translate("comparison.in_stock")}</span>`:`<span class="comparison-badge comparison-badge--danger">${this.translate("comparison.out_of_stock")}</span>`,"availability"),o.type.size>1&&(t+=this.buildAttributeRow(this.translate("comparison.type"),e,e=>e.type||"-","type")),t+=this.buildAttributeRow(this.translate("comparison.variants"),e,e=>e.variants?.length||0,"variants");const r=new Set;return e.forEach(e=>e.tags?.forEach(e=>{(e.includes("feature:")||e.includes("eigenschap:"))&&r.add(e.split(":")[1])})),r.size>0&&(t+='<div class="comparison-section">',t+=`<div class="comparison-section-title">${this.translate("comparison.features")}</div>`,Array.from(r).forEach(o=>{t+=this.buildAttributeRow(o,e,e=>{const t=e.tags?.some(e=>e.includes(o));return t?'<span class="comparison-check">✓</span>':'<span class="comparison-cross">✗</span>'},"feature")}),t+="</div>"),setTimeout(()=>{document.querySelectorAll("[data-remove-product]").forEach(e=>{e.addEventListener("click",e=>{const o=e.currentTarget.dataset.removeProduct;this.removeProduct(o);document.querySelector("[data-comparison-table]").innerHTML=this.buildComparisonTable(),this.comparedProducts.length<2&&this.hideComparison()})})},0),t+="</div>",t}buildAttributeRow(e,o,t,r="default"){const a=o.map(e=>t(e));let i=null;"price"===r?i="lower-better":"variants"===r&&(i="higher-better");let c='<div class="comparison-row">';return c+=`<div class="comparison-cell comparison-cell--label">${e}</div>`,o.forEach((e,o)=>{const t=a[o];let s="comparison-cell";if(i&&"availability"!==r){const e=a.map(e=>parseFloat(String(e).replace(/[^0-9.]/g,""))||0),t=e[o];if("lower-better"===i){t===Math.min(...e.filter(e=>e>0))&&t>0&&(s+=" comparison-cell--best")}else if("higher-better"===i){t===Math.max(...e)&&t>0&&(s+=" comparison-cell--best")}}c+=`<div class="${s}">${t}</div>`}),c+="</div>",c}extractAttributes(e){const o={type:new Set,tags:new Set,features:new Set};return e.forEach(e=>{e.type&&o.type.add(e.type),e.tags?.forEach(e=>{o.tags.add(e),(e.includes("feature:")||e.includes("eigenschap:"))&&o.features.add(e.split(":")[1])})}),o}formatPrice(e){return new Intl.NumberFormat(this.config.locale,{style:"currency",currency:"EUR"}).format(e)}saveToStorage(){try{localStorage.setItem(this.config.storageKey,JSON.stringify(this.comparedProducts.map(e=>({id:e.id,title:e.title,vendor:e.vendor,price:e.price,url:e.url,image:e.image,available:e.available,tags:e.tags,type:e.type,variants:e.variants}))))}catch(e){console.error("Failed to save comparison:",e)}}loadFromStorage(){try{const e=localStorage.getItem(this.config.storageKey);e&&(this.comparedProducts=JSON.parse(e))}catch(e){console.error("Failed to load comparison:",e),this.comparedProducts=[]}}showNotification(e,o="info"){const t=document.createElement("div");t.className=`comparison-notification comparison-notification--${o}`,t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.classList.add("active"),10),setTimeout(()=>{t.classList.remove("active"),setTimeout(()=>t.remove(),300)},3e3)}translate(e,o={}){const t=this.config.locale.split("-")[0],r={en:{"comparison.title":"Product Comparison","comparison.added":"Added {product} to comparison","comparison.removed":"Removed from comparison","comparison.cleared":"Comparison cleared","comparison.max_reached":"Maximum {max} products can be compared","comparison.min_required":"Select at least 2 products to compare","comparison.error_loading":"Error loading product","comparison.price":"Price","comparison.availability":"Availability","comparison.type":"Product Type","comparison.variants":"Variants","comparison.features":"Features","comparison.in_stock":"In Stock","comparison.out_of_stock":"Out of Stock","comparison.view_product":"View Product","comparison.remove":"Remove"},nl:{"comparison.title":"Productvergelijking","comparison.added":"{product} toegevoegd aan vergelijking","comparison.removed":"Verwijderd uit vergelijking","comparison.cleared":"Vergelijking gewist","comparison.max_reached":"Maximaal {max} producten kunnen worden vergeleken","comparison.min_required":"Selecteer minimaal 2 producten om te vergelijken","comparison.error_loading":"Fout bij laden product","comparison.price":"Prijs","comparison.availability":"Beschikbaarheid","comparison.type":"Producttype","comparison.variants":"Varianten","comparison.features":"Kenmerken","comparison.in_stock":"Op voorraad","comparison.out_of_stock":"Niet op voorraad","comparison.view_product":"Bekijk Product","comparison.remove":"Verwijderen"},de:{"comparison.title":"Produktvergleich","comparison.added":"{product} zum Vergleich hinzugefügt","comparison.removed":"Aus Vergleich entfernt","comparison.cleared":"Vergleich gelöscht","comparison.max_reached":"Maximal {max} Produkte können verglichen werden","comparison.min_required":"Wählen Sie mindestens 2 Produkte zum Vergleichen","comparison.error_loading":"Fehler beim Laden des Produkts","comparison.price":"Preis","comparison.availability":"Verfügbarkeit","comparison.type":"Produkttyp","comparison.variants":"Varianten","comparison.features":"Merkmale","comparison.in_stock":"Auf Lager","comparison.out_of_stock":"Nicht auf Lager","comparison.view_product":"Produkt ansehen","comparison.remove":"Entfernen"},fr:{"comparison.title":"Comparaison de produits","comparison.added":"{product} ajouté à la comparaison","comparison.removed":"Retiré de la comparaison","comparison.cleared":"Comparaison effacée","comparison.max_reached":"Maximum {max} produits peuvent être comparés","comparison.min_required":"Sélectionnez au moins 2 produits à comparer","comparison.error_loading":"Erreur de chargement du produit","comparison.price":"Prix","comparison.availability":"Disponibilité","comparison.type":"Type de produit","comparison.variants":"Variantes","comparison.features":"Caractéristiques","comparison.in_stock":"En stock","comparison.out_of_stock":"Rupture de stock","comparison.view_product":"Voir le produit","comparison.remove":"Retirer"}};let a=r[t]?.[e]||r.en[e]||e;return Object.keys(o).forEach(e=>{a=a.replace(`{${e}}`,o[e])}),a}}document.addEventListener("DOMContentLoaded",()=>{document.querySelector("[data-compare-bar]")&&(window.productComparison=new ProductComparison)});