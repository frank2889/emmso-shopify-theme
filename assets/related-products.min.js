class RelatedProducts{constructor(){this.container=document.querySelector("[data-related-products-container]"),this.productData=window.currentProductData,this.intelligence=window.SearchIntelligence?new window.SearchIntelligence:null,this.container&&this.productData&&this.init()}async init(){try{await this.fetchRelatedProducts()}catch(e){console.error("Failed to load related products:",e),this.showError()}}async fetchRelatedProducts(){if(!this.intelligence)return void console.warn("Search intelligence not available");const e=this.intelligence.getRelatedProductsQuery(this.productData);if(0===e.length)return void this.hideLoading();console.log("Finding related products with queries:",e);const t=e.map(e=>fetch(`/search/suggest.json?q=${encodeURIComponent(e)}&resources[type]=product&resources[limit]=8`).then(e=>e.ok?e.json():null).catch(()=>null)),r=await Promise.all(t),n=new Map;r.forEach(e=>{e?.resources?.results?.products&&e.resources.results.products.forEach(e=>{if(e.id!==this.productData.id){const t=e.id||e.handle;n.has(t)||n.set(t,e)}})});const a=Array.from(n.values()),o=this.rankRelatedProducts(a);this.displayProducts(o.slice(0,4))}rankRelatedProducts(e){return e.map(e=>{let t=0;if(e.vendor===this.productData.vendor&&(t+=50),e.product_type===this.productData.product_type&&(t+=40),e.tags&&this.productData.tags){t+=10*e.tags.filter(e=>this.productData.tags.includes(e)).length}const r=this.productData.price||0,n=e.price||0;Math.abs(r-n)/r<.3&&(t+=20),e.available&&(t+=15);const a=this.productData.title.toLowerCase().split(/\s+/),o=e.title.toLowerCase().split(/\s+/);return t+=5*a.filter(e=>e.length>3&&o.includes(e)).length,{...e,relevanceScore:t}}).sort((e,t)=>t.relevanceScore-e.relevanceScore)}displayProducts(e){if(0===e.length)return void(this.container.innerHTML=this.getEmptyState());const t=e.map((e,t)=>{const r=e.image||e.featured_image,n=this.formatPrice(e.price),a=e.compare_at_price?this.formatPrice(e.compare_at_price):null,o=0===t&&e.relevanceScore>50;return`\n        <a href="${e.url}" class="related-product-card" data-product-id="${e.id}">\n          <div class="related-product-card__image">\n            ${r?`\n              <img \n                src="${r}" \n                alt="${this.escapeHtml(e.title)}"\n                loading="lazy"\n                width="300"\n                height="300"\n              >\n            `:'\n              <div style="width: 100%; height: 100%; background: #E8E8E1;"></div>\n            '}\n            ${o?`\n              <span class="related-product-card__match-badge">\n                ${this.getMatchLabel()}\n              </span>\n            `:""}\n          </div>\n          <div class="related-product-card__content">\n            ${e.vendor?`<p class="related-product-card__vendor">${this.escapeHtml(e.vendor)}</p>`:""}\n            <h3 class="related-product-card__title">${this.escapeHtml(e.title)}</h3>\n            <div class="related-product-card__price ${a?"on-sale":""}">\n              ${a?`<span class="related-product-card__compare-price">${a}</span>`:""}\n              ${n}\n            </div>\n          </div>\n        </a>\n      `}).join("");this.container.innerHTML=t}getMatchLabel(){const e={nl:"Beste Match",de:"Beste Übereinstimmung",fr:"Meilleure Correspondance",es:"Mejor Coincidencia",it:"Migliore Corrispondenza",pt:"Melhor Correspondência",da:"Bedste Match",en:"Best Match"};return e[this.productData.locale||"en"]||e.en}getEmptyState(){const e={nl:"Geen gerelateerde producten gevonden",de:"Keine verwandten Produkte gefunden",fr:"Aucun produit connexe trouvé",es:"No se encontraron productos relacionados",it:"Nessun prodotto correlato trovato",pt:"Nenhum produto relacionado encontrado",da:"Ingen relaterede produkter fundet",en:"No related products found"};return`\n      <div class="related-products__empty">\n        <p>${e[this.productData.locale||"en"]||e.en}</p>\n      </div>\n    `}showError(){this.container.innerHTML='\n      <div class="related-products__error">\n        <p>Unable to load related products</p>\n      </div>\n    '}hideLoading(){const e=this.container.querySelector(".related-products__loading");e&&(e.style.display="none")}formatPrice(e){const t=e/100,r=this.productData.locale||"en";return new Intl.NumberFormat({nl:"nl-NL",de:"de-DE",fr:"fr-FR",es:"es-ES",it:"it-IT",pt:"pt-PT",da:"da-DK",en:"en-US"}[r]||"en-US",{style:"currency",currency:window.Shopify?.currency?.active||"EUR"}).format(t)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new RelatedProducts}):new RelatedProducts;