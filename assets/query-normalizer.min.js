class QueryNormalizer{constructor(){this.stopWords={en:["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","best","top","cheap","affordable"],nl:["de","het","een","en","of","maar","in","op","aan","voor","van","met","door","beste","goedkope"],de:["der","die","das","ein","eine","und","oder","aber","in","auf","an","zu","für","von","mit","beste","günstig"],fr:["le","la","les","un","une","et","ou","mais","dans","sur","à","pour","de","avec","par","meilleur","pas cher"],es:["el","la","los","las","un","una","y","o","pero","en","sobre","a","para","de","con","mejor","barato"],it:["il","lo","la","i","gli","le","un","uno","una","e","o","ma","in","su","a","per","di","con","migliore","economico"],pt:["o","a","os","as","um","uma","e","ou","mas","em","sobre","para","de","com","melhor","barato"],da:["den","det","de","en","et","og","eller","men","i","på","til","for","af","med","bedste","billig"]},this.synonymGroups=[["waterproof","waterresistant","water-resistant","water-proof"],["flooring","floor","floors","vloer","vloeren","boden","böden","sol","pavimento","gulv"],["vinyl","pvc","lvt","luxury-vinyl"],["laminate","laminaat","laminat"],["wood","wooden","timber","hout","houten","holz","bois","madera","legno","madeira"],["kitchen","keuken","küche","cuisine","cocina","cucina","cozinha","køkken"],["bathroom","badkamer","badezimmer","salle-de-bain","baño","bagno","casa-de-banho","badeværelse"]],this.spamPatterns=[/^test$/i,/^asdf/i,/^qwerty/i,/^\d+$/,/^[a-z]{1,2}$/i,/(.)\1{4,}/,/^[^a-z0-9\s]{3,}/i]}normalize(e,n="en"){const t=n.split("-")[0];let o=e.toLowerCase().trim().replace(/[^\w\s-]/g," ").replace(/\s+/g," ");const a=this.stopWords[t]||this.stopWords.en,i=o.split(" ");o=i.filter(e=>!a.includes(e)).join(" "),o=this.canonicalizeSynonyms(o);const r=o.split(" ").sort().join(" "),l=this.generateHandle(r),s=this.calculateQualityScore(e,o),c=this.isSpam(e);return{original:e,normalized:r,handle:l,qualityScore:s,isSpam:c,shouldCreateCollection:s>=.5&&!c,reason:this.getRecommendationReason(s,c)}}canonicalizeSynonyms(e){let n=e;return this.synonymGroups.forEach(e=>{const t=e[0],o=new RegExp(`\\b(${e.join("|")})\\b`,"gi");n=n.replace(o,t)}),n}generateHandle(e){return e.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"").replace(/-+/g,"-").replace(/^-|-$/g,"").substring(0,50)}calculateQualityScore(e,n){let t=.5;const o=n.split(" ").length;o>=2&&o<=4?t+=.2:(1===o||o>6)&&(t-=.2);const a=e.length;a>=10&&a<=30?t+=.1:(a<5||a>50)&&(t-=.2);["waterproof","vinyl","laminate","wood","kitchen","bathroom","floor","tile"].some(e=>n.includes(e))&&(t+=.2);return["product","item","thing","stuff"].some(e=>n.includes(e))&&(t-=.3),this.hasSpecificity(n)&&(t+=.1),Math.max(0,Math.min(1,t))}hasSpecificity(e){return["black","white","grey","gray","brown","beige","oak","walnut","waterproof","scratch-resistant","pet-friendly","eco-friendly","large","small","wide","narrow","kitchen","bathroom","living","bedroom"].some(n=>e.includes(n))}isSpam(e){return this.spamPatterns.some(n=>n.test(e))}getRecommendationReason(e,n){return n?"Query appears to be spam":e>=.7?"High-quality search query, excellent collection candidate":e>=.5?"Good search query, suitable for collection":e>=.3?"Low-quality query, consider improving search terms":"Poor query quality, not suitable for collection"}areDuplicates(e,n,t="en"){const o=this.normalize(e,t),a=this.normalize(n,t);if(o.normalized===a.normalized)return!0;if(o.handle===a.handle)return!0;return this.calculateSimilarity(o.normalized,a.normalized)>=.8}calculateSimilarity(e,n){const t=e.length>n.length?e:n,o=e.length>n.length?n:e;if(0===t.length)return 1;const a=this.levenshteinDistance(t,o);return(t.length-a)/t.length}levenshteinDistance(e,n){const t=[];for(let e=0;e<=n.length;e++)t[e]=[e];for(let n=0;n<=e.length;n++)t[0][n]=n;for(let o=1;o<=n.length;o++)for(let a=1;a<=e.length;a++)n.charAt(o-1)===e.charAt(a-1)?t[o][a]=t[o-1][a-1]:t[o][a]=Math.min(t[o-1][a-1]+1,t[o][a-1]+1,t[o-1][a]+1);return t[n.length][e.length]}findMatchingCollection(e,n,t="en"){const o=this.normalize(e,t),a=n.find(e=>e.handle===o.handle);if(a)return{collection:a,matchType:"exact",confidence:1};for(const e of n){const n=this.calculateSimilarity(o.normalized,e.handle.replace(/-/g," "));if(n>=.8)return{collection:e,matchType:"similar",confidence:n};if(this.normalize(e.title,t).normalized===o.normalized)return{collection:e,matchType:"title",confidence:1}}return null}batchNormalize(e,n="en"){const t=e.map(e=>({original:e,...this.normalize(e,n)})),o={};t.forEach(e=>{o[e.handle]||(o[e.handle]=[]),o[e.handle].push(e.original)});const a=Object.entries(o).map(([e,n])=>({handle:e,canonical:n.sort((e,n)=>e.length-n.length)[0],variants:n,count:n.length}));return{total:e.length,unique:a.length,duplicates:e.length-a.length,groups:a}}}"undefined"!=typeof module&&module.exports&&(module.exports=QueryNormalizer),"undefined"!=typeof window&&(window.QueryNormalizer=QueryNormalizer);