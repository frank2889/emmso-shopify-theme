class QueryNormalizer{constructor(){this.stopWords ={en:['the','a','an','and','or','but','in','on','at','to','for','of','with','by','from','best','top','cheap','affordable'],nl:['de','het','een','en','of','maar','in','op','aan','voor','van','met','door','beste','goedkope'],de:['der','die','das','ein','eine','und','oder','aber','in','auf','an','zu','für','von','mit','beste','günstig'],fr:['le','la','les','un','une','et','ou','mais','dans','sur','à','pour','de','avec','par','meilleur','pas cher'],es:['el','la','los','las','un','una','y','o','pero','en','sobre','a','para','de','con','mejor','barato'],it:['il','lo','la','i','gli','le','un','uno','una','e','o','ma','in','su','a','per','di','con','migliore','economico'],pt:['o','a','os','as','um','uma','e','ou','mas','em','sobre','para','de','com','melhor','barato'],da:['den','det','de','en','et','og','eller','men','i','på','til','for','af','med','bedste','billig']};this.synonymGroups = [ ['waterproof','waterresistant','water-resistant','water-proof'],['flooring','floor','floors','vloer','vloeren','boden','böden','sol','pavimento','gulv'],['vinyl','pvc','lvt','luxury-vinyl'],['laminate','laminaat','laminat'],['wood','wooden','timber','hout','houten','holz','bois','madera','legno','madeira'],['kitchen','keuken','küche','cuisine','cocina','cucina','cozinha','køkken'],['bathroom','badkamer','badezimmer','salle-de-bain','baño','bagno','casa-de-banho','badeværelse'] ];this.spamPatterns = [ /^test$/i,/^asdf/i,/^qwerty/i,/^\d+$/,/^[a-z]{1,2}$/i,/(.)\1{4,}/,/^[^a-z0-9\s]{3,}/i ];}normalize(query,locale = 'en'){const lang = locale.split('-')[0];let normalized = query .toLowerCase().trim().replace(/[^\w\s-]/g,' ').replace(/\s+/g,' ');const stopWords = this.stopWords[lang] || this.stopWords.en;const words = normalized.split(' ');const filteredWords = words.filter(word => !stopWords.includes(word));normalized = filteredWords.join(' ');normalized = this.canonicalizeSynonyms(normalized);const sortedWords = normalized.split(' ').sort().join(' ');const handle = this.generateHandle(sortedWords);const qualityScore = this.calculateQualityScore(query,normalized);const isSpam = this.isSpam(query);return{original:query,normalized:sortedWords,handle:handle,qualityScore:qualityScore,isSpam:isSpam,shouldCreateCollection:qualityScore >= 0.5 && !isSpam,reason:this.getRecommendationReason(qualityScore,isSpam)};}canonicalizeSynonyms(text){let canonicalized = text;this.synonymGroups.forEach(group =>{const canonical = group[0];const pattern = new RegExp(`\\b(${group.join('|')})\\b`,'gi');canonicalized = canonicalized.replace(pattern,canonical);});return canonicalized;}generateHandle(normalizedQuery){return normalizedQuery .toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').replace(/-+/g,'-').replace(/^-|-$/g,'').substring(0,50);}calculateQualityScore(original,normalized){let score = 0.5;const wordCount = normalized.split(' ').length;if(wordCount >= 2 && wordCount <= 4){score += 0.2;}else if(wordCount === 1 || wordCount > 6){score -= 0.2;}const length = original.length;if(length >= 10 && length <= 30){score += 0.1;}else if(length < 5 || length > 50){score -= 0.2;}const productTerms = ['waterproof','vinyl','laminate','wood','kitchen','bathroom','floor','tile'];const containsProductTerm = productTerms.some(term => normalized.includes(term));if(containsProductTerm){score += 0.2;}const genericTerms = ['product','item','thing','stuff'];const isGeneric = genericTerms.some(term => normalized.includes(term));if(isGeneric){score -= 0.3;}if(this.hasSpecificity(normalized)){score += 0.1;}return Math.max(0,Math.min(1,score));}hasSpecificity(query){const specificAttributes = [ 'black','white','grey','gray','brown','beige','oak','walnut','waterproof','scratch-resistant','pet-friendly','eco-friendly','large','small','wide','narrow','kitchen','bathroom','living','bedroom' ];return specificAttributes.some(attr => query.includes(attr));}isSpam(query){return this.spamPatterns.some(pattern => pattern.test(query));}getRecommendationReason(score,isSpam){if(isSpam){return 'Query appears to be spam';}if(score >= 0.7){return 'High-quality search query,excellent collection candidate';}else if(score >= 0.5){return 'Good search query,suitable for collection';}else if(score >= 0.3){return 'Low-quality query,consider improving search terms';}else{return 'Poor query quality,not suitable for collection';}}areDuplicates(query1,query2,locale = 'en'){const norm1 = this.normalize(query1,locale);const norm2 = this.normalize(query2,locale);if(norm1.normalized === norm2.normalized){return true;}if(norm1.handle === norm2.handle){return true;}const similarity = this.calculateSimilarity(norm1.normalized,norm2.normalized);return similarity >= 0.8;}calculateSimilarity(str1,str2){const longer = str1.length > str2.length ? str1:str2;const shorter = str1.length > str2.length ? str2:str1;if(longer.length === 0){return 1.0;}const editDistance = this.levenshteinDistance(longer,shorter);return(longer.length - editDistance)/ longer.length;}levenshteinDistance(str1,str2){const matrix = [];for(let i = 0;i <= str2.length;i++){matrix[i] = [i];}for(let j = 0;j <= str1.length;j++){matrix[0][j] = j;}for(let i = 1;i <= str2.length;i++){for(let j = 1;j <= str1.length;j++){if(str2.charAt(i - 1)=== str1.charAt(j - 1)){matrix[i][j] = matrix[i - 1][j - 1];}else{matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1,matrix[i][j - 1] + 1,matrix[i - 1][j] + 1);}}}return matrix[str2.length][str1.length];}findMatchingCollection(query,existingCollections,locale = 'en'){const normalized = this.normalize(query,locale);const exactMatch = existingCollections.find(c => c.handle === normalized.handle);if(exactMatch){return{collection:exactMatch,matchType:'exact',confidence:1.0};}for(const collection of existingCollections){const similarity = this.calculateSimilarity(normalized.normalized,collection.handle.replace(/-/g,' '));if(similarity >= 0.8){return{collection:collection,matchType:'similar',confidence:similarity};}const titleNorm = this.normalize(collection.title,locale);if(titleNorm.normalized === normalized.normalized){return{collection:collection,matchType:'title',confidence:1.0};}}return null;}batchNormalize(queries,locale = 'en'){const normalized = queries.map(q =>({original:q,...this.normalize(q,locale)}));const groups ={};normalized.forEach(item =>{if(!groups[item.handle]){groups[item.handle] = [];}groups[item.handle].push(item.original);});const canonical = Object.entries(groups).map(([handle,originals])=>({handle:handle,canonical:originals.sort((a,b)=> a.length - b.length)[0],variants:originals,count:originals.length}));return{total:queries.length,unique:canonical.length,duplicates:queries.length - canonical.length,groups:canonical};}}if(typeof module !== 'undefined' && module.exports){module.exports = QueryNormalizer;}if(typeof window !== 'undefined'){window.QueryNormalizer = QueryNormalizer;}