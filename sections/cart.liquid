{% comment %}
  Cart Section - Modern AJAX cart with search integration
  
  Features:
  - Real-time AJAX cart updates
  - Free shipping progress indicator
  - Search-based product recommendations
  - Recently viewed products
  - Quantity controls with +/- buttons
  - Empty cart state with search prompt
  
  Dependencies:
  - assets/cart.css (BEM-styled cart layout)
  - assets/cart.js (AJAX updates, quantity controls)
  - snippets/css-variables.liquid (color system)
{% endcomment %}

{% render 'css-variables' %}
<link rel="stylesheet" href="{{ 'cart.css' | asset_url }}">

<div class="cart" data-cart-wrapper>
  {%- if cart.item_count > 0 -%}
    {%- comment %} Cart Header {% endcomment -%}
    <div class="cart__header">
      <h1 class="cart__title">{{ 'cart.title' | t }}</h1>
      <p class="cart__count">
        {{ 'cart.item_count' | t: count: cart.item_count }}
      </p>
    </div>

    {%- comment %} Free Shipping Progress Bar {% endcomment -%}
    {%- if section.settings.show_free_shipping_bar and section.settings.free_shipping_threshold > 0 -%}
      {%- assign threshold = section.settings.free_shipping_threshold | times: 100 -%}
      {%- assign cart_total = cart.total_price -%}
      {%- assign remaining = threshold | minus: cart_total -%}
      {%- assign progress = cart_total | times: 100 | divided_by: threshold -%}
      {%- if progress > 100 -%}
        {%- assign progress = 100 -%}
      {%- endif -%}
      
      <div class="cart__shipping-bar" data-shipping-bar>
        {%- if remaining > 0 -%}
          <p class="cart__shipping-message">
            {{ 'cart.free_shipping_remaining' | t: amount: remaining | money }}
          </p>
        {%- else -%}
          <p class="cart__shipping-message cart__shipping-message--success">
            {{ 'cart.free_shipping_eligible' | t }}
          </p>
        {%- endif -%}
        <div class="cart__shipping-progress">
          <div class="cart__shipping-fill" style="width: {{ progress }}%"></div>
        </div>
      </div>
    {%- endif -%}

    {%- comment %} Cart Form {% endcomment -%}
    <form action="{{ routes.cart_url }}" method="post" class="cart__form" data-cart-form>
      
      {%- comment %} Cart Items {% endcomment -%}
      <div class="cart__items" data-cart-items>
        {% for item in cart.items %}
          <div class="cart-item" data-cart-item data-line-index="{{ forloop.index }}">
            
            {%- comment %} Product Image {% endcomment -%}
            <div class="cart-item__image">
              {% if item.image %}
                {% render 'image', 
                  image: item.image, 
                  url: item.url,
                  alt: item.title,
                  sizes: '120px',
                  loading: 'lazy'
                %}
              {% else %}
                <img 
                  src="{{ 'product-placeholder.svg' | asset_url }}" 
                  alt="{{ item.title }}"
                  loading="lazy"
                >
              {% endif %}
            </div>

            {%- comment %} Product Details {% endcomment -%}
            <div class="cart-item__details">
              <h3 class="cart-item__title">
                <a href="{{ item.url }}">{{ item.product.title }}</a>
              </h3>
              
              {%- comment %} Variant Details {% endcomment -%}
              {%- unless item.product.has_only_default_variant -%}
                <p class="cart-item__variant">
                  {{ item.variant.title }}
                </p>
              {%- endunless -%}

              {%- comment %} Properties (Engraving, etc.) {% endcomment -%}
              {%- if item.properties.size > 0 -%}
                <ul class="cart-item__properties">
                  {% for property in item.properties %}
                    {% assign property_first_char = property.first | slice: 0 %}
                    {%- if property.last != blank and property_first_char != '_' -%}
                      <li>
                        <strong>{{ property.first }}:</strong> {{ property.last }}
                      </li>
                    {%- endif -%}
                  {% endfor %}
                </ul>
              {%- endif -%}

              {%- comment %} Price {% endcomment -%}
              <div class="cart-item__price">
                {%- if item.original_price != item.final_price -%}
                  <span class="cart-item__price--original">
                    {{ item.original_price | money }}
                  </span>
                  <span class="cart-item__price--sale">
                    {{ item.final_price | money }}
                  </span>
                {%- else -%}
                  <span class="cart-item__price--regular">
                    {{ item.final_price | money }}
                  </span>
                {%- endif -%}
              </div>

              {%- comment %} Discounts {% endcomment -%}
              {%- if item.line_level_discount_allocations.size > 0 -%}
                <ul class="cart-item__discounts">
                  {% for discount in item.line_level_discount_allocations %}
                    <li class="cart-item__discount">
                      {{ discount.discount_application.title }} (-{{ discount.amount | money }})
                    </li>
                  {% endfor %}
                </ul>
              {%- endif -%}

              {%- comment %} Remove Button {% endcomment -%}
              <button 
                type="button" 
                class="cart-item__remove" 
                data-remove-item
                data-index="{{ forloop.index }}"
                aria-label="{{ 'cart.remove' | t }}"
              >
                {{ 'cart.remove' | t }}
              </button>
            </div>

            {%- comment %} Quantity Controls {% endcomment -%}
            <div class="cart-item__quantity">
              <button 
                type="button" 
                class="cart-item__qty-button" 
                data-qty-decrease
                data-index="{{ forloop.index }}"
                aria-label="{{ 'cart.decrease_quantity' | t }}"
              >
                -
              </button>
              <input 
                type="number" 
                name="updates[]" 
                value="{{ item.quantity }}"
                min="0"
                class="cart-item__qty-input"
                data-qty-input
                data-index="{{ forloop.index }}"
                aria-label="{{ 'cart.quantity' | t }}"
              >
              <button 
                type="button" 
                class="cart-item__qty-button" 
                data-qty-increase
                data-index="{{ forloop.index }}"
                aria-label="{{ 'cart.increase_quantity' | t }}"
              >
                +
              </button>
            </div>

            {%- comment %} Line Total {% endcomment -%}
            <div class="cart-item__total">
              {{ item.final_line_price | money }}
            </div>
          </div>
        {% endfor %}
      </div>

      {%- comment %} Cart Footer {% endcomment -%}
      <div class="cart__footer">
        
        {%- comment %} Cart Note {% endcomment -%}
        {%- if section.settings.show_cart_note -%}
          <div class="cart__note">
            <label for="cart-note">{{ 'cart.note' | t }}</label>
            <textarea 
              id="cart-note" 
              name="note" 
              class="cart__note-textarea"
              placeholder="{{ 'cart.note_placeholder' | t }}"
            >{{ cart.note }}</textarea>
          </div>
        {%- endif -%}

        {%- comment %} Cart Totals {% endcomment -%}
        <div class="cart__totals">
          
          {%- comment %} Subtotal {% endcomment -%}
          <div class="cart__subtotal">
            <span>{{ 'cart.subtotal' | t }}</span>
            <span data-cart-subtotal>{{ cart.total_price | money }}</span>
          </div>

          {%- comment %} Cart-level Discounts {% endcomment -%}
          {%- if cart.cart_level_discount_applications.size > 0 -%}
            <ul class="cart__discounts">
              {% for discount in cart.cart_level_discount_applications %}
                <li class="cart__discount">
                  <span>{{ discount.title }}</span>
                  <span>-{{ discount.total_allocated_amount | money }}</span>
                </li>
              {% endfor %}
            </ul>
          {%- endif -%}

          {%- comment %} Shipping Note {% endcomment -%}
          <p class="cart__shipping-note">
            {{ 'cart.shipping_at_checkout' | t }}
          </p>

          {%- comment %} Checkout Button {% endcomment -%}
          <button 
            type="submit" 
            name="checkout" 
            class="cart__checkout-button"
            data-checkout-button
          >
            {{ 'cart.checkout' | t }}
          </button>

          {%- comment %} Continue Shopping {% endcomment -%}
          <a href="{{ routes.all_products_collection_url }}" class="cart__continue-shopping">
            {{ 'cart.continue_shopping' | t }}
          </a>
        </div>
      </div>
    </form>

    {%- comment %} Upsell Products {% endcomment -%}
    {%- if section.settings.show_upsell and section.settings.upsell_collection != blank -%}
      {%- assign upsell_collection = collections[section.settings.upsell_collection] -%}
      {%- if upsell_collection.products.size > 0 -%}
        <div class="cart__upsell">
          <h2 class="cart__upsell-title">{{ section.settings.upsell_title }}</h2>
          <div class="cart__upsell-products">
            {%- for product in upsell_collection.products limit: 4 -%}
              <div class="cart__upsell-product">
                <a href="{{ product.url }}" class="cart__upsell-link">
                  {%- if product.featured_image -%}
                    {% render 'image', 
                      image: product.featured_image, 
                      sizes: '200px',
                      loading: 'lazy'
                    %}
                  {%- endif -%}
                  <h3>{{ product.title }}</h3>
                  <p class="cart__upsell-price">{{ product.price | money }}</p>
                </a>
                {%- if product.available -%}
                  <button 
                    type="button" 
                    class="cart__upsell-add-to-cart btn btn--primary"
                    data-product-id="{{ product.id }}"
                    data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                    aria-label="{{ 'products.product.add_to_cart' | t }}: {{ product.title }}"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <circle cx="9" cy="21" r="1"></circle>
                      <circle cx="20" cy="21" r="1"></circle>
                      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span>{{ 'products.product.add_to_cart' | t }}</span>
                  </button>
                {%- else -%}
                  <button class="cart__upsell-add-to-cart btn btn--disabled" disabled>
                    {{ 'products.product.sold_out' | t }}
                  </button>
                {%- endif -%}
              </div>
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}
    {%- endif -%}

  {%- else -%}
    {%- comment %} Empty Cart State {% endcomment -%}
    <div class="cart--empty">
      <div class="cart__empty-icon">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
      </div>
      <h2 class="cart__empty-title">{{ 'cart.empty_title' | t }}</h2>
      <p class="cart__empty-message">{{ 'cart.empty_message' | t }}</p>
      
      {%- comment %} Search Prompt {% endcomment -%}
      <div class="cart__empty-search">
        <p>{{ 'cart.empty_search_prompt' | t }}</p>
        <a href="{{ routes.search_url }}" class="cart__empty-search-button">
          {{ 'cart.start_searching' | t }}
        </a>
      </div>

      {%- comment %} Popular Products {% endcomment -%}
      {%- if section.settings.empty_cart_collection != blank -%}
        {%- assign popular_collection = collections[section.settings.empty_cart_collection] -%}
        {%- if popular_collection.products.size > 0 -%}
          <div class="cart__popular">
            <h3>{{ 'cart.popular_products' | t }}</h3>
            <div class="cart__popular-products">
              {%- for product in popular_collection.products limit: 3 -%}
                <div class="cart__popular-product">
                  <a href="{{ product.url }}" class="cart__popular-link">
                    {%- if product.featured_image -%}
                      {% render 'image', 
                        image: product.featured_image,
                        sizes: '150px',
                        loading: 'lazy'
                      %}
                    {%- endif -%}
                    <h4>{{ product.title }}</h4>
                    <p class="cart__popular-price">{{ product.price | money }}</p>
                  </a>
                  {%- if product.available -%}
                    <button 
                      type="button" 
                      class="cart__popular-add-to-cart btn btn--primary"
                      data-product-id="{{ product.id }}"
                      data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                      aria-label="{{ 'products.product.add_to_cart' | t }}: {{ product.title }}"
                    >
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                      </svg>
                      <span>{{ 'products.product.add_to_cart' | t }}</span>
                    </button>
                  {%- else -%}
                    <button class="cart__popular-add-to-cart btn btn--disabled" disabled>
                      {{ 'products.product.sold_out' | t }}
                    </button>
                  {%- endif -%}
                </div>
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}
      {%- endif -%}
    </div>
  {%- endif -%}
</div>

<script src="{{ 'cart.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "t:general.cart",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.cart.settings.header__shipping"
    },
    {
      "type": "checkbox",
      "id": "show_free_shipping_bar",
      "label": "t:sections.cart.settings.show_free_shipping_bar.label",
      "default": true
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "t:sections.cart.settings.free_shipping_threshold.label",
      "info": "t:sections.cart.settings.free_shipping_threshold.info",
      "default": 50
    },
    {
      "type": "header",
      "content": "t:sections.cart.settings.header__cart_options"
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "t:sections.cart.settings.show_cart_note.label",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.cart.settings.header__upsell"
    },
    {
      "type": "checkbox",
      "id": "show_upsell",
      "label": "t:sections.cart.settings.show_upsell.label",
      "default": true
    },
    {
      "type": "text",
      "id": "upsell_title",
      "label": "t:sections.cart.settings.upsell_title.label",
      "default": "You may also like"
    },
    {
      "type": "collection",
      "id": "upsell_collection",
      "label": "t:sections.cart.settings.upsell_collection.label",
      "info": "t:sections.cart.settings.upsell_collection.info"
    },
    {
      "type": "header",
      "content": "t:sections.cart.settings.header__empty_cart"
    },
    {
      "type": "collection",
      "id": "empty_cart_collection",
      "label": "t:sections.cart.settings.empty_cart_collection.label",
      "info": "t:sections.cart.settings.empty_cart_collection.info"
    }
  ]
}
{% endschema %}
